<!DOCTYPE html>
<!-- 
==========================================
é£Ÿåˆ» Foodtime - è¥å…»è®°å½•åº”ç”¨æ¶æ„åˆ†æ
==========================================

ğŸ“± é¡µé¢ç»“æ„ (Pages)
- page-today: ä»Šæ—¥è®°å½•é¡µé¢ï¼ŒåŒ…å«æ‹ç…§è¯†åˆ«ã€æ–‡å­—è¾“å…¥ã€è¥å…»ç»Ÿè®¡
- page-history: å†å²è®°å½•é¡µé¢ï¼Œæ”¯æŒå‘¨/æœˆè§†å›¾ã€æ—¥å†é€‰æ‹©ã€å›¾è¡¨å±•ç¤º
- page-profile: ä¸ªäººèµ„æ–™é¡µé¢ï¼Œæ˜¾ç¤ºç”¨æˆ·ä¿¡æ¯ã€ä¼šå‘˜çŠ¶æ€ã€è®¾ç½®å…¥å£
- page-settings-profile: ä¸ªäººèµ„æ–™è®¾ç½®é¡µé¢ï¼Œç¼–è¾‘åŸºæœ¬ä¿¡æ¯
- page-settings-goals: è¥å…»ç›®æ ‡è®¾ç½®é¡µé¢ï¼Œé…ç½®ä¸‰å¥—é¢„è®¾ç›®æ ‡

ğŸ¯ æ ¸å¿ƒæ¨¡å— (Core Modules)
- AIè¯†åˆ«æ¨¡å—: è°ƒç”¨é€šä¹‰åƒé—®APIè¿›è¡Œå›¾ç‰‡/æ–‡å­—é£Ÿç‰©è¯†åˆ«å’Œè¥å…»åˆ†æ
- æ•°æ®å­˜å‚¨æ¨¡å—: åŸºäºlocalStorageçš„è½»é‡çº§æ•°æ®æŒä¹…åŒ–æ–¹æ¡ˆ
- ä¸»é¢˜åˆ‡æ¢æ¨¡å—: æ”¯æŒè‡ªåŠ¨/æ‰‹åŠ¨æ˜æš—ä¸»é¢˜åˆ‡æ¢ï¼Œé€‚é…iOSç³»ç»Ÿ
- å›¾è¡¨å±•ç¤ºæ¨¡å—: åŸºäºEChartsçš„è¥å…»æ•°æ®å¯è§†åŒ–å±•ç¤º

ğŸ”§ å·¥å…·å‡½æ•° (Utility Functions)
- æ—¥æœŸå¤„ç†: ymdKeyã€addDaysã€startOfWeekç­‰æ—¥æœŸæ ¼å¼åŒ–å·¥å…·
- è¥å…»è®¡ç®—: calcTotalsã€getTargetCarbsç­‰è¥å…»æˆåˆ†è®¡ç®—å‡½æ•°
- å›¾ç‰‡å¤„ç†: compressImageå›¾ç‰‡å‹ç¼©å’ŒBase64è½¬æ¢
- æ•°æ®æ ¼å¼åŒ–: formatMealTextç”Ÿæˆé£Ÿç‰©æè¿°æ–‡æ¡ˆ

ğŸ¨ UIç»„ä»¶ (UI Components)
- åº•éƒ¨å¯¼èˆªæ : ä¸‰å¤§é¡µé¢åˆ‡æ¢ï¼Œæ”¯æŒæ‰‹åŠ¿æ»‘åŠ¨
- å¼¹å±‚ç³»ç»Ÿ: AIç¡®è®¤å¼¹å±‚ã€å†å²è¯¦æƒ…å¼¹å±‚ã€å®¢æœå¸®åŠ©å¼¹å±‚
- è¿›åº¦æ¡ç»„ä»¶: è¥å…»ç›®æ ‡å®Œæˆåº¦å¯è§†åŒ–å±•ç¤º
- é¤æ¬¡é€‰æ‹©å™¨: æ—©é¤/åˆé¤/æ™šé¤/å¤œå®µ/åŠ é¤åˆ‡æ¢

ğŸ“Š æ•°æ®æ¨¡å‹ (Data Models)
- Meal: é¤æ¬¡è®°å½•ï¼ŒåŒ…å«æ—¶é—´ã€ç±»å‹ã€é£Ÿç‰©åˆ—è¡¨ã€è¥å…»æ€»è®¡
- User: ç”¨æˆ·ä¿¡æ¯ï¼ŒåŒ…å«ä¸ªäººèµ„æ–™ã€è¥å…»ç›®æ ‡é¢„è®¾
- GoalPresets: ä¸‰å¥—è¥å…»ç›®æ ‡é…ç½®ï¼ˆå¢è‚Œ/ç»´æŒ/å‡è„‚ï¼‰

ğŸ”„ çŠ¶æ€ç®¡ç† (State Management)
- å½“å‰é¤æ¬¡çŠ¶æ€: currentMealè·Ÿè¸ªç”¨æˆ·é€‰æ‹©çš„é¤æ¬¡ç±»å‹
- å†å²é¡µçŠ¶æ€: historyViewã€periodStartã€selectedDateç®¡ç†è§†å›¾çŠ¶æ€
- AIä¼šè¯çŠ¶æ€: __aiSessionç®¡ç†AIè¯†åˆ«çš„ä¼šè¯æ•°æ®
- ç¼–è¾‘çŠ¶æ€: editingOldMealKeyã€tempAiItemsForEditç®¡ç†ç¼–è¾‘æ¨¡å¼

âš¡ äº¤äº’åŠŸèƒ½ (Interactive Features)
- æ‰‹åŠ¿æ”¯æŒ: é¡µé¢æ»‘åŠ¨åˆ‡æ¢ã€å›¾ç‰‡é€‰æ‹©
- å®æ—¶ç¼–è¾‘: AIè¯†åˆ«ç»“æœå¯æ‰‹åŠ¨è°ƒæ•´ä»½é‡å’Œåˆ é™¤é¡¹ç›®
- æ™ºèƒ½ä¿®æ­£: æ”¯æŒæ–‡å­—æŒ‡ä»¤ä¿®æ­£AIè¯†åˆ«ç»“æœ
- ç¦»çº¿æ”¯æŒ: Service Workerå®ç°PWAç¦»çº¿åŠŸèƒ½

==========================================
-->
<html lang="zh-CN">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover" />
    <meta name="apple-mobile-web-app-capable" content="yes">
<meta name="color-scheme" content="light dark">
    <meta name="theme-color" media="(prefers-color-scheme: light)" content="#FFFFFF">
<meta name="theme-color" media="(prefers-color-scheme: dark)"  content="#111827">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>é£Ÿåˆ» Foodtime</title>
    <link rel="manifest" href="/manifest.webmanifest">
<script>
// æ³¨å†ŒSWå¹¶æä¾›æ›´æ–°æç¤º
if('serviceWorker' in navigator){
  window.addEventListener('load',()=>{
    navigator.serviceWorker.register('/sw.js').then(reg=>{
      const show = (w)=>{
        const b=document.getElementById('update-banner'); if(!b) return;
        b.classList.remove('hidden');
        b.querySelector('[data-refresh]')?.addEventListener('click',()=> w.postMessage({type:'SKIP_WAITING'}),{once:true});
      };
      if(reg.waiting) show(reg.waiting);
      reg.addEventListener('updatefound',()=>{
        const nw = reg.installing; if(!nw) return;
        nw.addEventListener('statechange',()=>{
          if(nw.state==='installed' && navigator.serviceWorker.controller){ show(nw); }
        });
      });
    });
    navigator.serviceWorker.addEventListener('controllerchange',()=> location.reload());
  });
}
</script>
    <link href="https://cdn.bootcdn.net/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet" />
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="/shared/nutrition.js"></script>
    <script src="/shared/date.js"></script>
    <!-- æŒ‰éœ€åŠ è½½ï¼šè¿›å…¥å†å²é¡µæ—¶å†åŠ¨æ€å¼•å…¥ ECharts -->
    <meta id="meta-theme-color-runtime" name="theme-color" content="#FFFFFF">
    <script>
      tailwind.config = {
        darkMode: 'class',
        theme: {
          extend: {
            colors: {
              primary: '#FF7A00',
              secondary: '#00B4D8',
              success: '#10B981',
              warning: '#EF4444',
              purple: '#8B5CF6',
              neutral: {
                100: '#F9FAFB',
                200: '#F3F4F6',
                300: '#E5E7EB',
                400: '#D1D5DB',
                500: '#9CA3AF',
                600: '#6B7280',
                700: '#4B5563',
                800: '#1F2937',
                900: '#111827'
              }
            },
            fontFamily: {
              'sf-pro': ['-apple-system','BlinkMacSystemFont','Segoe UI','Roboto','Helvetica Neue','Arial','sans-serif'],
            },
            borderRadius: { xl: '16px' },
            boxShadow: {
              light: '0 4px 12px rgba(0,0,0,0.05)',
              medium: '0 6px 16px rgba(0,0,0,0.08)'
            }
          }
        }
      }
    </script>
    <script>
      // è½»é‡é˜»æ­¢æ‰‹åŠ¿ç¼©æ”¾ï¼ˆæ³¨æ„ï¼šä¼šç¦ç”¨åŒæŒ‡ç¼©æ”¾ï¼‰
      document.addEventListener('gesturestart', e => e.preventDefault());
      let lastTouchEnd = 0;
      document.addEventListener('touchend', e => {
        const now = Date.now();
        if (now - lastTouchEnd <= 300) e.preventDefault();
        lastTouchEnd = now;
      }, false);
    </script>
    <script>
      // Toast è¾…åŠ©ï¼ˆé¡µé¢è„šæœ¬å¯ç›´æ¥è°ƒç”¨ showToastï¼‰
      function showToast(message, duration){
        const el = document.getElementById('toast');
        if(!el) return;
        el.textContent = message || '';
        el.classList.remove('hidden');
        clearTimeout(window.__toastTimer);
        window.__toastTimer = setTimeout(()=> el.classList.add('hidden'), Math.max(1200, duration||2000));
      }
    </script>
    <style type="text/tailwindcss">   
      @layer utilities {
        /* iOS é˜²æ­¢è¾“å…¥æ¡†èšç„¦è§¦å‘ç¼©æ”¾ï¼šè¡¨å•åŸºçº¿ 16px */
@supports (-webkit-touch-callout: none) {
  input, select, textarea {
    font-size: 16px;
  }
}

/* è®©é¡µé¢æ›´"åŸç”Ÿ"ï¼šé˜²æ­¢åŒå‡»æ”¾å¤§ã€ä¼˜åŒ–æ»šåŠ¨ */
html, body {
  -webkit-text-size-adjust: 100%;
  touch-action: manipulation;
  overscroll-behavior-y: none;
}
        .content-auto { content-visibility:auto; }
        .scrollbar-hide { -ms-overflow-style:none; scrollbar-width:none; }
        .scrollbar-hide::-webkit-scrollbar { display:none; }
        .transition-transform-shadow{ transition: transform .2s ease, box-shadow .2s ease; }
        .touch-target{ min-height:44px; min-width:44px; }
        .calendar-day{ aspect-ratio:1/1; }  
        /* â€”â€” iOS é¡¶éƒ¨å®‰å…¨åŒºï¼ˆé€‚é…çµåŠ¨å²›/åˆ˜æµ·ï¼‰â€”â€” */
.safe-top{
  /* è€ç‰ˆ iOS */
  padding-top: constant(safe-area-inset-top);
  /* æ–°ç‰ˆ iOS / iPhone 15 Pro Max ç­‰ */
  padding-top: env(safe-area-inset-top);
}
/* â€”â€” iOS åº•éƒ¨å®‰å…¨åŒºï¼ˆé¿å…åº•æ é®æŒ¡ï¼‰â€”â€” */
.safe-bottom{
  /* è€ç‰ˆ iOS */
  padding-bottom: constant(safe-area-inset-bottom);
  /* æ–°ç‰ˆ iOS */
  padding-bottom: env(safe-area-inset-bottom);
}

/* â€”â€” åŸç”ŸåŒ–ï¼šå‹æ„Ÿã€ç¦é«˜äº®ã€ç¦é•¿æŒ‰èœå•ã€ç¦é€‰æ‹© â€”â€” */
html, body {
  -webkit-tap-highlight-color: transparent;
  -webkit-touch-callout: none;
  user-select: none;
}
/* è¡¨å•/å¯ç¼–è¾‘åŒºåŸŸå…è®¸é€‰æ‹©ä¸é•¿æŒ‰ */
input, textarea, [contenteditable="true"], [contenteditable=""] {
  -webkit-user-select: text;
  user-select: text;
  -webkit-touch-callout: default;
}

/* æŒ‰å‹åé¦ˆï¼šç‚¹å‡»ç¼©æ”¾ 0.98 */
.touch-target:active, button:active, a:active {
  transform: scale(0.98);
}
/* å¯¼èˆª/è’™å±‚æ¯›ç»ç’ƒæ—¶çš„æ€§èƒ½ä¼˜åŒ– */
.backdrop-blur-md { -webkit-backdrop-filter: blur(12px); backdrop-filter: blur(12px); }
.backdrop-blur-sm { -webkit-backdrop-filter: blur(6px);  backdrop-filter: blur(6px); }
      }
      
    </style>
  </head>
  <body class="font-sf-pro bg-neutral-100 dark:bg-neutral-900 text-neutral-800 dark:text-neutral-100 transition-colors duration-300 scrollbar-hide">
    <!-- é¡¶éƒ¨å¯¼èˆªï¼ˆé€šç”¨ï¼‰ -->
    <header class="safe-top sticky top-0 z-50 bg-white/80 dark:bg-neutral-900/80 backdrop-blur-md border-b border-neutral-200 dark:border-neutral-800 transition-all duration-300">
      <div class="container mx-auto px-4 py-3 flex justify-between items-center">
        <h1 id="app-title" class="text-xl font-semibold">é£Ÿåˆ» Foodtime</h1>
        <div class="flex items-center space-x-4">
          <button id="theme-toggle" class="touch-target flex items-center justify-center rounded-full p-2 hover:bg-neutral-200 dark:hover:bg-neutral-800 transition-colors">
            <i class="fa-solid fa-moon dark:hidden text-neutral-700"></i>
            <i class="fa-solid fa-sun hidden dark:block text-neutral-300"></i>
          </button>
          <button id="help-btn" type="button" class="touch-target flex items-center justify-center rounded-full p-2 hover:bg-neutral-200 dark:hover:bg-neutral-800 transition-colors">
            <i class="fa-solid fa-question-circle text-neutral-700 dark:text-neutral-300"></i>
          </button>
        </div>
      </div>
    </header>

    <!-- ä¸»ä½“ï¼šä¸‰ä¸ªåˆ†åŒºï¼ˆä»Šå¤© / å†å² / æˆ‘çš„ï¼‰ -->
    <main class="container mx-auto px-4 py-6" style="padding-bottom: calc(3.9rem + env(safe-area-inset-bottom));">
      <!-- æ›´æ–°æç¤ºæ¡ -->
      <div id="update-banner" class="hidden fixed left-1/2 -translate-x-1/2 bottom-[6.2rem] z-50 bg-neutral-900 text-white text-sm px-4 py-2 rounded-full shadow-lg flex items-center gap-2">
        <span>æœ‰æ–°ç‰ˆæœ¬å¯ç”¨</span>
        <button data-refresh class="px-2 py-1 bg-primary rounded-full text-white text-xs">ç‚¹æˆ‘åˆ·æ–°</button>
      </div>
      <!-- ä»Šå¤© -->
      <section id="page-today" class="block overflow-y-auto scrollbar-hide pb-8" style="max-height: calc(100vh - 6rem - 5.5rem - env(safe-area-inset-bottom));">
        <!-- ä»Šæ—¥æ ‡å‡†å¡ -->
        <section class="mb-6 bg-white dark:bg-neutral-800 rounded-xl shadow-light p-6 border border-neutral-200 dark:border-neutral-700">
          <div class="flex justify-between items-center mb-4">
            <h2 class="text-lg font-semibold">ä»Šæ—¥æ ‡å‡†</h2>
            <span id="current-date" class="text-sm text-neutral-500 dark:text-neutral-400">â€”</span>
          </div>
          <div class="flex rounded-xl bg-neutral-100 dark:bg-neutral-700 p-1 mb-6">
            <button class="flex-1 py-2 px-4 rounded-lg text-sm font-medium transition-all" data-mode="high">å¢è‚Œ</button>
            <button class="flex-1 py-2 px-4 rounded-lg text-sm font-medium bg-white dark:bg-neutral-600 shadow-sm transition-all" data-mode="normal">ç»´æŒ</button>
            <button class="flex-1 py-2 px-4 rounded-lg text-sm font-medium transition-all" data-mode="low">å‡è„‚</button>
          </div>
          <div class="grid grid-cols-3 gap-6 mb-6">
            <div class="text-center">
              <div class="text-xs text-neutral-500 dark:text-neutral-400 mb-1">çƒ­é‡</div>
              <div class="flex items-center justify-center">
                <input id="goal-cal" class="w-16 text-center text-base font-medium bg-transparent border-b border-neutral-300 dark:border-neutral-600 focus:border-primary dark:focus:border-primary focus:outline-none" type="text" value="2000"/>
                <span class="text-xs text-neutral-500 dark:text-neutral-400 ml-1">kcal</span>
              </div>
            </div>
            <div class="text-center">
              <div class="text-xs text-neutral-500 dark:text-neutral-400 mb-1">è›‹ç™½è´¨</div>
              <div class="flex items-center justify-center">
                <input id="goal-pro" class="w-16 text-center text-base font-medium bg-transparent border-b border-neutral-300 dark:border-neutral-600 focus:border-primary dark:focus:border-primary focus:outline-none" type="text" value="100"/>
                <span class="text-xs text-neutral-500 dark:text-neutral-400 ml-1">g</span>
              </div>
            </div>
            <div class="text-center">
              <div class="text-xs text-neutral-500 dark:text-neutral-400 mb-1">è„‚è‚ª</div>
              <div class="flex items-center justify-center">
                <input id="goal-fat" class="w-16 text-center text-base font-medium bg-transparent border-b border-neutral-300 dark:border-neutral-600 focus:border-primary dark:focus:border-primary focus:outline-none" type="text" value="65"/>
                <span class="text-xs text-neutral-500 dark:text-neutral-400 ml-1">g</span>
              </div>
            </div>
          </div>
          <div class="flex justify-between items-center">
            <button id="reset-goal" class="text-xs text-primary hover:text-primary/80 transition-colors">é‡ç½®ç›®æ ‡</button>
            <div class="flex space-x-2">
              <div class="flex items-center space-x-1">
                <label class="relative inline-flex items-center cursor-pointer">
                  <input id="night-snack" class="sr-only peer" type="checkbox" />
                  <div class="w-9 h-5 bg-neutral-200 dark:bg-neutral-700 rounded-full peer peer-checked:after:translate-x-full after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-primary"></div>
                </label>
                <span class="text-xs">å¤œå®µ</span>
              </div>
              <div class="flex items-center space-x-1">
                <label class="relative inline-flex items-center cursor-pointer">
                  <input id="snack" class="sr-only peer" type="checkbox" />
                  <div class="w-9 h-5 bg-neutral-200 dark:bg-neutral-700 rounded-full peer peer-checked:after:translate-x-full after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-primary"></div>
                </label>
                <span class="text-xs">åŠ é¤</span>
              </div>
            </div>
          </div>
        </section>

        <!-- é€‰æ‹©é¤æ¬¡ -->
        <section class="mb-6 overflow-x-auto scrollbar-hide">
          <div class="flex space-x-2 pb-2 min-w-max">
            <button id="breakfast-chip" class="px-5 py-2 rounded-xl text-sm font-medium bg-neutral-100 dark:bg-neutral-700 transition-transform-shadow touch-target">æ—©é¤</button>
<button id="lunch-chip"     class="px-5 py-2 rounded-xl text-sm font-medium bg-neutral-100 dark:bg-neutral-700 transition-transform-shadow touch-target">åˆé¤</button>
<button id="dinner-chip"    class="px-5 py-2 rounded-xl text-sm font-medium bg-primary text-white transition-transform-shadow touch-target">æ™šé¤</button>
            <button id="night-snack-chip" class="px-5 py-2 rounded-xl text-sm font-medium bg-neutral-100 dark:bg-neutral-700 transition-transform-shadow touch-target opacity-50 hidden">å¤œå®µ</button>
            <button id="snack-chip" class="px-5 py-2 rounded-xl text-sm font-medium bg-neutral-100 dark:bg-neutral-700 transition-transform-shadow touch-target opacity-50 hidden">åŠ é¤</button>
          </div>
        </section>

        <!-- è®°å½•æœ¬é¤ -->
        <section class="mb-8">
          <div class="flex flex-col items-center mb-6">
            <button id="camera-btn" class="w-24 h-24 rounded-full bg-primary flex items-center justify-center shadow-medium mb-4 transition-transform-shadow touch-target">
              <i class="fa-solid fa-camera text-white text-2xl"></i>
            </button>
            <input id="photo-input" type="file" accept="image/*" capture="environment" class="hidden" />
            <input id="gallery-input" type="file" accept="image/*" class="hidden" />
            <p class="text-xs text-neutral-500 dark:text-neutral-400 text-center max-w-xs">è¯·ä¿¯æ‹é£Ÿç‰©ï¼Œä»¥æå‡å‡†ç¡®åº¦</p>
          </div>
          <div class="mb-5">
            <textarea id="meal-text" class="w-full p-4 rounded-xl border border-neutral-300 dark:border-neutral-600 bg-white dark:bg-neutral-800 min-h-[100px] resize-none focus:outline-none focus:ring-2 focus:ring-primary/30 focus:border-primary dark:focus:border-primary transition-all" placeholder="å°è¯•è¾“å…¥ï¼šåƒäº†ä¸€ç¢—ç‰›è‚‰é¢ï¼Œå–äº†ä¸€æ¯å¯ä¹..."></textarea>
          </div>
          <button id="save-meal-btn" aria-label="AIè¯†åˆ«æ–‡å­—" class="w-full py-3 bg-primary text-white rounded-xl font-medium shadow transition-transform-shadow touch-target active:scale-95">AIè¯†åˆ«æ–‡å­—</button>
        </section>

        <!-- ä»Šæ—¥ç»Ÿè®¡ -->
        
        <section class="mb-8 bg-white dark:bg-neutral-800 rounded-xl shadow-light p-6 border border-neutral-200 dark:border-neutral-700">
          <h2 class="text-lg font-semibold mb-4">ä»Šæ—¥ç»Ÿè®¡</h2>
        
          <!-- çƒ­é‡ï¼ˆç¬¬1æ’ï¼‰ -->
          <div class="mb-6">
            <div class="flex justify-between text-sm mb-2">
              <span>çƒ­é‡æ‘„å…¥</span>
              <span id="calories-progress" class="font-medium">0 / 2000 kcal</span>
            </div>
            <div class="w-full h-2 bg-neutral-100 dark:bg-neutral-700 rounded-full overflow-hidden">
              <div id="calories-bar" class="h-full bg-primary rounded-full" style="width:0%"></div>
            </div>
          </div>
        
          <!-- è›‹ç™½è´¨ï¼ˆç¬¬2æ’ï¼‰ -->
          <div class="mb-5">
            <div class="flex justify-between text-sm mb-2">
              <span>è›‹ç™½è´¨</span>
              <span id="stat-protein" class="font-medium">0 g</span>
            </div>
            <div class="w-full h-2 bg-neutral-100 dark:bg-neutral-700 rounded-full overflow-hidden">
              <div id="protein-bar" class="h-full bg-primary rounded-full" style="width:0%"></div>
            </div>
            <div class="text-xs text-neutral-500 dark:text-neutral-400 mt-1">
              ç›®æ ‡ <span id="goal-pro-label">100</span> g
            </div>
          </div>
        
          <!-- ç¢³æ°´ï¼ˆç¬¬3æ’ï¼‰ -->
          <div class="mb-5">
            <div class="flex justify-between text-sm mb-2">
              <span>ç¢³æ°´</span>
              <span id="stat-carbs" class="font-medium">0 g</span>
            </div>
            <div class="w-full h-2 bg-neutral-100 dark:bg-neutral-700 rounded-full overflow-hidden">
              <div id="carbs-bar" class="h-full bg-secondary rounded-full" style="width:0%"></div>
            </div>
            <div class="text-xs text-neutral-500 dark:text-neutral-400 mt-1">
              ç›®æ ‡ <span id="goal-carbs-label">0</span> g
            </div>
          </div>
        
          <!-- è„‚è‚ªï¼ˆç¬¬4æ’ï¼‰ -->
          <div>
            <div class="flex justify-between text-sm mb-2">
              <span>è„‚è‚ª</span>
              <span id="stat-fat" class="font-medium">0 g</span>
            </div>
            <div class="w-full h-2 bg-neutral-100 dark:bg-neutral-700 rounded-full overflow-hidden">
              <div id="fat-bar" class="h-full bg-purple rounded-full" style="width:0%"></div>
            </div>
            <div class="text-xs text-neutral-500 dark:text-neutral-400 mt-1">
              ç›®æ ‡ <span id="goal-fat-label">65</span> g
            </div>
          </div>
        </section>

        <!-- ä»Šæ—¥å·²è®°å½•åˆ—è¡¨ -->
        <section>
          <h2 class="text-lg font-semibold mb-4 tracking-wide">ä»Šæ—¥å·²è®°å½•</h2>
          <div id="meals-list" class="space-y-3"></div>
          <div id="empty-state-today" class="hidden flex flex-col items-center justify-center py-12 text-center">
  <p class="text-neutral-500 dark:text-neutral-400">æ‹ç…§æˆ–æ–‡å­—è®°å½•å¼€å§‹</p>
</div>
          </div>
        </section>
      </section>

      <!-- å†å² -->
<section id="page-history" class="hidden overflow-y-auto scrollbar-hide pb-8" style="max-height: calc(100vh - 6rem - 5.5rem - env(safe-area-inset-bottom));">
  <!-- é¡¶éƒ¨ï¼šå‘¨æœŸ + è§†å›¾åˆ‡æ¢ -->
  <section class="mb-6 bg-white dark:bg-neutral-800 rounded-xl shadow-light p-5 border border-neutral-200 dark:border-neutral-700">
    <div class="flex justify-between items-center mb-5">
      <button id="prev-period" class="touch-target flex items-center justify-center rounded-full p-2 text-neutral-500 dark:text-neutral-400 hover:bg-neutral-100 dark:hover:bg-neutral-800 transition-colors">
        <i class="fa-solid fa-chevron-left text-sm"></i>
      </button>
      <h2 id="current-period" class="text-lg font-semibold">â€”</h2>
      <button id="next-period" class="touch-target flex items-center justify-center rounded-full p-2 text-neutral-500 dark:text-neutral-400 hover:bg-neutral-100 dark:hover:bg-neutral-800 transition-colors disabled:opacity-50 disabled:hover:bg-transparent">
        <i class="fa-solid fa-chevron-right text-sm"></i>
      </button>
    </div>

    <div class="flex rounded-xl bg-neutral-100 dark:bg-neutral-800 p-1">
      <button id="btn-week"  class="flex-1 py-2 px-4 rounded-lg text-sm font-medium bg-white dark:bg-neutral-700 shadow-sm transition-all" data-view="week">å‘¨è§†å›¾</button>
      <button id="btn-month" class="flex-1 py-2 px-4 rounded-lg text-sm font-medium transition-all" data-view="month">æœˆè§†å›¾</button>
    </div>
  </section>

  <!-- æ—¥å†ï¼ˆå‘¨/æœˆåº•éƒ¨ç”¨ JS å¡«å……ï¼‰ -->
  <section class="mb-6 bg-white dark:bg-neutral-800 rounded-xl shadow-light p-5 border border-neutral-200 dark:border-neutral-700">
    <div id="calendar-wrap"></div>
  </section>

  <!-- æŒ‡æ ‡åˆ‡æ¢ + å›¾è¡¨ -->
  <section class="mb-6 bg-white dark:bg-neutral-800 rounded-xl shadow-light p-5 border border-neutral-200 dark:border-neutral-700">
    <div class="flex rounded-xl bg-neutral-100 dark:bg-neutral-700 p-1 mb-6">
      <button class="flex-1 py-2 px-4 rounded-lg text-sm font-medium bg-white dark:bg-neutral-600 shadow-sm transition-all" data-metric="calories">çƒ­é‡</button>
      <button class="flex-1 py-2 px-4 rounded-lg text-sm font-medium transition-all" data-metric="protein">è›‹ç™½è´¨</button>
      <button class="flex-1 py-2 px-4 rounded-lg text-sm font-medium transition-all" data-metric="carbs">ç¢³æ°´</button>
      <button class="flex-1 py-2 px-4 rounded-lg text-sm font-medium transition-all" data-metric="fat">è„‚è‚ª</button>
    </div>
    <div id="metrics-chart" class="h-72"></div>
  </section>

  <!-- è®°å½•ç‡ + è¾¾æ ‡ç‡ï¼ˆæ¼”ç¤ºé™æ€ï¼‰ -->
  

  <!-- æŸå¤©è¯¦æƒ…ï¼ˆJS åŠ¨æ€æ¸²æŸ“ï¼‰ -->
  <section class="mb-6 bg-white dark:bg-neutral-800 rounded-xl shadow-light p-5 border border-neutral-200 dark:border-neutral-700" id="daily-details">
    <div class="mb-5">
      <h2 id="detail-date" class="text-lg font-semibold mb-1">â€”</h2>
      <p id="daily-target" class="text-sm text-neutral-500 dark:text-neutral-400">â€”</p>
    </div>
    <div id="daily-meals" class="space-y-4 mb-6"></div>
    <div id="daily-summary" class="pt-4 border-t border-neutral-200 dark:border-neutral-700 hidden"></div>
  </section>
</section>

      <!-- æˆ‘çš„ -->
      <section id="page-profile" class="hidden overflow-y-auto scrollbar-hide pb-8" style="max-height: calc(100vh - 6rem - 5.5rem - env(safe-area-inset-bottom));">
        <div class="space-y-6">
          <section class="bg-white dark:bg-neutral-800 rounded-xl shadow-light p-6 border border-neutral-200 dark:border-neutral-700">
            <div class="flex items-center justify-between">
              <div class="flex items-center space-x-4">
                <label for="avatar-upload" class="relative w-16 h-16 rounded-full overflow-hidden cursor-pointer group">
  <img id="profile-avatar"
     src="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'><rect width='64' height='64' rx='32' fill='%23E5E7EB'/><circle cx='32' cy='24' r='10' fill='%239CA3AF'/><ellipse cx='32' cy='46' rx='16' ry='12' fill='%239CA3AF'/></svg>"
     class="w-full h-full object-cover rounded-full border border-neutral-300 dark:border-neutral-700"/>
  <div class="absolute inset-0 bg-black/30 opacity-0 group-hover:opacity-100 flex items-center justify-center text-white text-xs">æ›´æ¢</div>
  <input id="avatar-upload" type="file" accept="image/*" class="hidden" />
</label>
                <div class="leading-tight">
                  <div class="text-xl font-semibold tracking-tight" id="profile-name">å¥åº·é¥®é£Ÿè€…</div>
                  <div class="text-neutral-500 dark:text-neutral-400 text-sm mt-0.5" id="profile-basic">ç”· 32å²</div>
                  <div class="text-neutral-500 dark:text-neutral-400 text-sm mt-0.5" id="profile-body">175cm / 70kg</div>
                </div>
              </div>
              <button id="profile-edit" class="px-4 py-2 rounded-xl border border-neutral-300 dark:border-neutral-600 text-sm">ç¼–è¾‘</button>
            </div>
          </section>
          <section class="bg-white dark:bg-neutral-800 rounded-xl shadow-light p-6 border border-neutral-200 dark:border-neutral-700">
            <div class="flex items-center justify-between mb-3">
              <h3 class="text-lg font-semibold tracking-tight">ä¼šå‘˜ä¸ä»˜è´¹çŠ¶æ€</h3>
              <button id="open-vip" class="px-4 py-2 bg-primary text-white rounded-xl text-sm">å»å¼€é€š <i class="fa-solid fa-chevron-right ml-1 text-xs"></i></button>
            </div>
            <div class="text-neutral-700 dark:text-neutral-300 font-medium mb-0.5 leading-snug">è¯•ç”¨ä¸­</div>
            <div class="text-neutral-500 dark:text-neutral-400 text-sm leading-snug">åˆ°æœŸæ—¥æœŸï¼š2025-12-31</div>
            <div class="mt-3 p-3 rounded-lg bg-neutral-50 dark:bg-neutral-700 text-sm text-neutral-600 dark:text-neutral-300 leading-snug"><i class="fa-solid fa-info-circle mr-2 text-primary"></i>é«˜çº§ä¼šå‘˜å¯äº«å—ä¸“ä¸šé¥®é£Ÿåˆ†æã€AIè¥å…»è¯„ä¼°ä¸æŒ‡å¯¼ç­‰ç‰¹æƒ</div>
          </section>
          <!-- ç»‘å®šæ•™ç»ƒ -->
          <section class="bg-white dark:bg-neutral-800 rounded-xl shadow-light p-6 border border-neutral-200 dark:border-neutral-700">
            <div class="flex items-center justify-between mb-2">
              <h3 class="text-lg font-semibold tracking-tight">ç»‘å®šæ•™ç»ƒ</h3>
              <button id="bind-coach" class="px-4 py-2 bg-primary text-white rounded-xl text-sm">å»ç»‘å®š <i class="fa-solid fa-chevron-right ml-1 text-xs"></i></button>
            </div>
            <div class="text-neutral-600 dark:text-neutral-300 text-sm leading-snug">ç»‘å®šåå¯è·å¾—ä¸“å±æ•™ç»ƒç£å¯¼ä¸é¥®é£Ÿè®­ç»ƒå»ºè®®</div>
          </section>
          <section class="bg-white dark:bg-neutral-800 rounded-xl shadow-light p-6 border border-neutral-200 dark:border-neutral-700">
            <div class="flex items-center justify-between mb-2.5">
              <h3 class="text-lg font-semibold tracking-tight">è¥å…»ä¸ç›®æ ‡</h3>
              <button id="profile-goal-btn" class="px-4 py-2 rounded-xl border border-neutral-300 dark:border-neutral-600 text-sm">è¿›å…¥è®¾ç½® <i class="fa-solid fa-chevron-right ml-1 text-xs"></i></button>
            </div>
            <div class="text-neutral-600 dark:text-neutral-300 text-sm whitespace-nowrap leading-snug">
              ç›®æ ‡ï¼š<span id="profile-goal-cal">2000</span>kcal ï½œ P<span id="profile-goal-pro">100</span>g ï½œ C<span id="profile-goal-carbs">0</span>g ï½œ F<span id="profile-goal-fat">65</span>g
            </div>
          </section>
        </div>
        <div class="pt-8 pb-12 text-center text-xs text-neutral-400">
          The app was designed by ç‚¼é‡‘æœ¯å¸ˆ
        </div>
      </section>
<!-- è®¾ç½® Â· ä¸ªäººèµ„æ–™ï¼ˆäºŒçº§é¡µé¢ï¼‰ -->
<section id="page-settings-profile" class="hidden overflow-y-auto scrollbar-hide pb-8" style="max-height: calc(100vh - 6rem - 5.5rem - env(safe-area-inset-bottom));">
  <!-- é¡¶éƒ¨ï¼šè¿”å› + ä¿å­˜ -->
  <section class="mb-4 bg-white dark:bg-neutral-800 rounded-xl shadow-light p-4 border border-neutral-200 dark:border-neutral-700 flex items-center justify-between">
    <button id="settings-back-profile" class="px-3 py-2 rounded-lg border border-neutral-300 dark:border-neutral-600 text-sm">è¿”å›</button>
    <div class="text-lg font-semibold">ä¸ªäººèµ„æ–™</div>
    <button id="settings-save-profile" class="px-4 py-2 bg-primary text-white rounded-xl text-sm">ä¿å­˜</button>
  </section>

  <!-- ä¸ªäººèµ„æ–™è¡¨å• -->
  <section class="mb-6 bg-white dark:bg-neutral-800 rounded-xl shadow-light p-5 border border-neutral-200 dark:border-neutral-700">
    <h3 class="text-lg font-semibold mb-3">ä¸ªäººèµ„æ–™</h3>
    <div class="grid grid-cols-2 gap-3 text-sm">
      <label class="flex flex-col gap-1"><span class="text-neutral-500">æ˜µç§°</span><input id="f-name" class="p-2 rounded-lg border bg-white/80 dark:bg-neutral-700/60"></label>
      <label class="flex flex-col gap-1"><span class="text-neutral-500">æ€§åˆ«ï¼ˆç”·/å¥³ï¼‰</span><input id="f-gender" class="p-2 rounded-lg border bg-white/80 dark:bg-neutral-700/60"></label>
      <label class="flex flex-col gap-1"><span class="text-neutral-500">å¹´é¾„</span><input id="f-age" type="number" class="p-2 rounded-lg border bg-white/80 dark:bg-neutral-700/60"></label>
      <label class="flex flex-col gap-1"><span class="text-neutral-500">èº«é«˜(cm)</span><input id="f-height" type="number" class="p-2 rounded-lg border bg-white/80 dark:bg-neutral-700/60"></label>
      <label class="flex flex-col gap-1"><span class="text-neutral-500">ä½“é‡(kg)</span><input id="f-weight" type="number" class="p-2 rounded-lg border bg-white/80 dark:bg-neutral-700/60"></label>
      <label class="flex flex-col gap-1"><span class="text-neutral-500">ä½“è„‚(%)</span><input id="f-bodyfat" type="number" step="0.1" min="0" max="50" class="p-2 rounded-lg border bg-white/80 dark:bg-neutral-700/60" placeholder="å¯é€‰"></label>
    </div>
  </section>
  <!-- AI å»ºè®®ï¼ˆåŸºäºèµ„æ–™ç”Ÿæˆå¢è‚Œ/ç»´æŒ/å‡è„‚ä¸‰å¥—æ‘„å…¥å»ºè®®ï¼‰ -->
  <section class="mb-6 bg-white dark:bg-neutral-800 rounded-xl shadow-light p-5 border border-neutral-200 dark:border-neutral-700">
    <div class="flex items-center justify-between mb-3">
      <h3 class="text-lg font-semibold">AI å»ºè®®</h3>
      <button id="profile-ai-suggest" class="px-4 py-2 bg-primary text-white rounded-xl text-sm">ç”Ÿæˆå»ºè®®</button>
    </div>
    <div class="text-xs text-neutral-500 dark:text-neutral-400 mb-3">ä¾æ®ä½ çš„èº«é«˜ã€ä½“é‡å’Œä½“è„‚ï¼ˆå¯é€‰ï¼‰ç”Ÿæˆçƒ­é‡ã€è›‹ç™½ã€è„‚è‚ªã€ç¢³æ°´å»ºè®®ã€‚</div>
    <div id="profile-ai-note" class="text-xs text-primary mb-3"></div>
    <div id="profile-ai-result" class="grid grid-cols-1 sm:grid-cols-3 gap-3"></div>
  </section>
</section>

<!-- è®¾ç½® Â· è¥å…»ç›®æ ‡ï¼ˆäºŒçº§é¡µé¢ï¼‰ -->
<section id="page-settings-goals" class="hidden overflow-y-auto scrollbar-hide pb-8" style="max-height: calc(100vh - 6rem - 5.5rem - env(safe-area-inset-bottom));">
  <!-- é¡¶éƒ¨ï¼šè¿”å› + ä¿å­˜ -->
  <section class="mb-4 bg-white dark:bg-neutral-800 rounded-xl shadow-light p-4 border border-neutral-200 dark:border-neutral-700 flex items-center justify-between">
    <button id="settings-back-goal" class="px-3 py-2 rounded-lg border border-neutral-300 dark:border-neutral-600 text-sm">è¿”å›</button>
    <div class="text-lg font-semibold">è¥å…»ç›®æ ‡é¢„è®¾</div>
    <button id="settings-save-goal" class="px-4 py-2 bg-primary text-white rounded-xl text-sm">ä¿å­˜</button>
  </section>

  <!-- ä¿ç•™çº¯æ‰‹åŠ¨å¡«å†™ï¼Œä¸å†æä¾›AIç”Ÿæˆå…¥å£ -->
  <section class="mb-6 bg-white dark:bg-neutral-800 rounded-xl shadow-light p-5 border border-neutral-200 dark:border-neutral-700">
    <h3 class="text-lg font-semibold mb-3">å¢è‚Œ</h3>
    <div class="grid grid-cols-4 gap-3 text-sm">
      <label class="flex flex-col gap-1"><span class="text-neutral-500">çƒ­é‡(kcal)</span><input id="g-high-cal" type="number" class="p-2 rounded-lg border bg-white/80 dark:bg-neutral-700/60"></label>
      <label class="flex flex-col gap-1"><span class="text-neutral-500">è›‹ç™½(g)</span><input id="g-high-pro" type="number" class="p-2 rounded-lg border bg-white/80 dark:bg-neutral-700/60"></label>
      <label class="flex flex-col gap-1"><span class="text-neutral-500">è„‚è‚ª(g)</span><input id="g-high-fat" type="number" class="p-2 rounded-lg border bg-white/80 dark:bg-neutral-700/60"></label>
      <label class="flex flex-col gap-1"><span class="text-neutral-500">ç¢³æ°´(g)</span><input id="g-high-carb" type="number" class="p-2 rounded-lg border bg-white/80 dark:bg-neutral-700/60 text-center" placeholder="è‡ªåŠ¨è®¡ç®—ï¼Œå¯æ”¹"></label>
    </div>
  </section>
  <section class="mb-6 bg-white dark:bg-neutral-800 rounded-xl shadow-light p-5 border border-neutral-200 dark:border-neutral-700">
    <h3 class="text-lg font-semibold mb-3">ç»´æŒ</h3>
    <div class="grid grid-cols-4 gap-3 text-sm">
      <label class="flex flex-col gap-1"><span class="text-neutral-500">çƒ­é‡(kcal)</span><input id="g-normal-cal" type="number" class="p-2 rounded-lg border bg-white/80 dark:bg-neutral-700/60"></label>
      <label class="flex flex-col gap-1"><span class="text-neutral-500">è›‹ç™½(g)</span><input id="g-normal-pro" type="number" class="p-2 rounded-lg border bg-white/80 dark:bg-neutral-700/60"></label>
      <label class="flex flex-col gap-1"><span class="text-neutral-500">è„‚è‚ª(g)</span><input id="g-normal-fat" type="number" class="p-2 rounded-lg border bg-white/80 dark:bg-neutral-700/60"></label>
      <label class="flex flex-col gap-1"><span class="text-neutral-500">ç¢³æ°´(g)</span><input id="g-normal-carb" type="number" class="p-2 rounded-lg border bg-white/80 dark:bg-neutral-700/60 text-center" placeholder="è‡ªåŠ¨è®¡ç®—ï¼Œå¯æ”¹"></label>
    </div>
  </section>
  <section class="mb-6 bg-white dark:bg-neutral-800 rounded-xl shadow-light p-5 border border-neutral-200 dark:border-neutral-700">
    <h3 class="text-lg font-semibold mb-3">å‡è„‚</h3>
    <div class="grid grid-cols-4 gap-3 text-sm">
      <label class="flex flex-col gap-1"><span class="text-neutral-500">çƒ­é‡(kcal)</span><input id="g-low-cal" type="number" class="p-2 rounded-lg border bg-white/80 dark:bg-neutral-700/60"></label>
      <label class="flex flex-col gap-1"><span class="text-neutral-500">è›‹ç™½(g)</span><input id="g-low-pro" type="number" class="p-2 rounded-lg border bg-white/80 dark:bg-neutral-700/60"></label>
      <label class="flex flex-col gap-1"><span class="text-neutral-500">è„‚è‚ª(g)</span><input id="g-low-fat" type="number" class="p-2 rounded-lg border bg-white/80 dark:bg-neutral-700/60"></label>
      <label class="flex flex-col gap-1"><span class="text-neutral-500">ç¢³æ°´(g)</span><input id="g-low-carb" type="number" class="p-2 rounded-lg border bg-white/80 dark:bg-neutral-700/60 text-center" placeholder="è‡ªåŠ¨è®¡ç®—ï¼Œå¯æ”¹"></label>
    </div>
    <p class="text-xs text-neutral-500 mt-3">è¯´æ˜ï¼šç¢³æ°´æ ¹æ®ã€Œçƒ­é‡ - è›‹ç™½Ã—4 - è„‚è‚ªÃ—9ã€è‡ªåŠ¨æ¨ç®—ã€‚</p>
  </section>
</section>
    </main>

    <!-- åº•éƒ¨å¯¼èˆªæ  -->
    <nav class="fixed bottom-0 left-0 right-0 bg-white/95 dark:bg-neutral-800/95 backdrop-blur-md border-t border-neutral-200 dark:border-neutral-700 z-40" style="height:calc(3.9rem + env(safe-area-inset-bottom)); padding-bottom: env(safe-area-inset-bottom);">
      <div class="grid grid-cols-3 h-[3.9rem]">
        <button id="tab-today" class="flex flex-col items-center justify-center text-primary"><i class="fa-solid fa-utensils text-[18px] mb-0.5"></i><span class="text-[12px]">ä»Šå¤©</span></button>
        <button id="tab-history" class="flex flex-col items-center justify-center text-neutral-500 dark:text-neutral-400"><i class="fa-solid fa-history text-[18px] mb-0.5"></i><span class="text-[12px]">å†å²</span></button>
        <button id="tab-profile" class="flex flex-col items-center justify-center text-neutral-500 dark:text-neutral-400"><i class="fa-solid fa-user text-[18px] mb-0.5"></i><span class="text-[12px]">æˆ‘çš„</span></button>
      </div>
    </nav>

    <!-- å®¢æœå¼¹çª— -->
    <div id="help-modal" class="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 hidden items-center justify-center">
      <div class="bg-white dark:bg-neutral-800 w-full max-w-md mx-4 rounded-2xl max-h-[85vh] overflow-y-auto">
        <div class="flex justify-between items-center p-6 border-b border-neutral-200 dark:border-neutral-700">
          <div class="text-lg font-semibold">å®¢æœå¸®åŠ©</div>
          <button id="help-close" class="p-2 text-neutral-500 dark:text-neutral-400 hover:text-neutral-700 dark:hover:text-neutral-200 transition-colors">
            <i class="fa-solid fa-xmark"></i>
          </button>
        </div>
        <div class="p-6 space-y-6">
          <div>
            <h3 class="text-base font-medium mb-3 text-neutral-800 dark:text-neutral-200">å¸¸è§é—®é¢˜</h3>
            <div class="space-y-3">
              <div class="p-3 rounded-lg bg-neutral-50 dark:bg-neutral-700/50">
                <div class="font-medium text-sm mb-1">å¦‚ä½•è®°å½•é£Ÿç‰©ï¼Ÿ</div>
                <div class="text-xs text-neutral-600 dark:text-neutral-400">ç‚¹å‡»æ‹ç…§æŒ‰é’®æ‹æ‘„é£Ÿç‰©ç…§ç‰‡ï¼Œæˆ–ç›´æ¥è¾“å…¥æ–‡å­—æè¿°ï¼ŒAIä¼šè‡ªåŠ¨è¯†åˆ«è¥å…»æˆåˆ†ã€‚</div>
              </div>
              <div class="p-3 rounded-lg bg-neutral-50 dark:bg-neutral-700/50">
                <div class="font-medium text-sm mb-1">å¦‚ä½•è®¾ç½®è¥å…»ç›®æ ‡ï¼Ÿ</div>
                <div class="text-xs text-neutral-600 dark:text-neutral-400">åœ¨"æˆ‘çš„"é¡µé¢å¯ä»¥è®¾ç½®ä¸ªäººèµ„æ–™å’Œè¥å…»ç›®æ ‡ï¼Œæ”¯æŒå¢è‚Œã€ç»´æŒã€å‡è„‚ä¸‰ç§æ¨¡å¼ã€‚</div>
              </div>
              <div class="p-3 rounded-lg bg-neutral-50 dark:bg-neutral-700/50">
                <div class="font-medium text-sm mb-1">å¦‚ä½•æŸ¥çœ‹å†å²è®°å½•ï¼Ÿ</div>
                <div class="text-xs text-neutral-600 dark:text-neutral-400">ç‚¹å‡»åº•éƒ¨"å†å²"æ ‡ç­¾ï¼Œå¯ä»¥æŸ¥çœ‹å‘¨è§†å›¾å’Œæœˆè§†å›¾çš„é¥®é£Ÿè®°å½•å’Œè¥å…»ç»Ÿè®¡ã€‚</div>
              </div>
            </div>
          </div>
          <div>
            <h3 class="text-base font-medium mb-3 text-neutral-800 dark:text-neutral-200">è”ç³»å®¢æœ</h3>
            <div class="space-y-3">
              <div class="flex items-center p-3 rounded-lg bg-neutral-50 dark:bg-neutral-700/50">
                <i class="fa-solid fa-envelope text-primary mr-3"></i>
                <div>
                  <div class="font-medium text-sm">é‚®ç®±å®¢æœ</div>
                  <div class="text-xs text-neutral-600 dark:text-neutral-400">support@foodtime.com</div>
                </div>
              </div>
              <div class="flex items-center p-3 rounded-lg bg-neutral-50 dark:bg-neutral-700/50">
                <i class="fa-solid fa-comments text-primary mr-3"></i>
                <div>
                  <div class="font-medium text-sm">åœ¨çº¿å®¢æœ</div>
                  <div class="text-xs text-neutral-600 dark:text-neutral-400">å·¥ä½œæ—¥ 9:00-18:00</div>
                </div>
              </div>
              <div class="flex items-center p-3 rounded-lg bg-neutral-50 dark:bg-neutral-700/50">
                <i class="fa-solid fa-phone text-primary mr-3"></i>
                <div>
                  <div class="font-medium text-sm">ç”µè¯å®¢æœ</div>
                  <div class="text-xs text-neutral-600 dark:text-neutral-400">400-123-4567</div>
                </div>
              </div>
            </div>
          </div>
          <div>
            <h3 class="text-base font-medium mb-3 text-neutral-800 dark:text-neutral-200">æ„è§åé¦ˆ</h3>
            <div class="space-y-3">
              <textarea id="feedback-text" class="w-full p-3 rounded-lg border border-neutral-300 dark:border-neutral-600 bg-white dark:bg-neutral-700 text-sm resize-none focus:outline-none focus:ring-2 focus:ring-primary/30 focus:border-primary dark:focus:border-primary transition-all" placeholder="è¯·å‘Šè¯‰æˆ‘ä»¬æ‚¨çš„å»ºè®®æˆ–é‡åˆ°çš„é—®é¢˜..." rows="3"></textarea>
              <button id="submit-feedback" class="w-full py-3 bg-primary text-white rounded-lg font-medium shadow transition-transform-shadow touch-target hover:bg-primary/90 active:scale-95">æäº¤åé¦ˆ</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Toast å®¹å™¨ï¼ˆç»Ÿä¸€æç¤ºï¼‰ -->
    <div id="toast" class="fixed left-1/2 -translate-x-1/2 bottom-[7.2rem] z-50 px-4 py-2 bg-black/80 text-white text-sm rounded-full hidden"></div>

    <!-- å†å²é¤è¯¦æƒ…å¼¹å±‚ï¼ˆç”¨äºæŸ¥çœ‹/ä¿®æ”¹æŸé¤ï¼‰ -->
    <div id="hist-meal-modal" class="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 hidden items-end sm:items-center justify-center">
      <div class="bg-white dark:bg-neutral-800 w-full sm:w-[540px] rounded-t-2xl sm:rounded-2xl max-h-[85vh] overflow-y-auto relative">
        <div class="flex justify-between items-center p-5 border-b border-neutral-200 dark:border-neutral-700">
          <div class="text-lg font-semibold" id="hm-title">é¤æ¬¡è¯¦æƒ…</div>
          <button id="hm-close" class="p-2 text-neutral-500 dark:text-neutral-400"><i class="fa-solid fa-xmark"></i></button>
        </div>
        <div class="p-5">
          <div class="text-neutral-500 dark:text-neutral-400 mb-3" id="hm-date">â€”</div>
          <div id="hm-items" class="space-y-3"></div>
          <div class="mt-4 pt-4 border-t border-neutral-200 dark:border-neutral-700">
            <div class="flex justify-between font-semibold mb-1">
              <span>æœ¬é¤æ€»è®¡</span>
              <span id="hm-total-kcal">0kcal</span>
            </div>
            <div class="grid grid-cols-3 gap-2 text-sm text-neutral-500 dark:text-neutral-400">
              <div>è›‹ç™½è´¨ <span id="hm-total-pro">0</span>g</div>
              <div>ç¢³æ°´ <span id="hm-total-carb">0</span>g</div>
              <div>è„‚è‚ª <span id="hm-total-fat">0</span>g</div>
            </div>
          </div>
          <div class="mt-4">
            <label class="text-sm font-medium block mb-2">ä¿®æ­£è¯´æ˜</label>
            <textarea id="hm-note" class="w-full p-3 bg-neutral-100 dark:bg-neutral-700 rounded-xl text-sm resize-none" placeholder="å¦‚ï¼šå¤šåƒäº†ä¸€ä¸ªé¸¡è›‹"></textarea>
          </div>
          <div class="flex gap-3 mt-5">
            <button id="hm-delete" class="flex-1 py-3 rounded-xl border border-neutral-300 dark:border-neutral-600 text-sm">åˆ é™¤æœ¬é¤</button>
            <button id="hm-save"   class="flex-1 py-3 rounded-xl bg-primary text-white text-sm">è®© AI ç”Ÿæˆæ–°çš„ä¸€é¤</button>
          </div>
        </div>
        <!-- åŠ è½½é®ç½© -->
        <div id="hm-loading" class="hidden absolute inset-0 bg-black/30 flex items-center justify-center">
          <div class="px-4 py-2 rounded-full bg-neutral-800 text-white text-sm">AI ç”Ÿæˆä¸­â€¦</div>
        </div>
      </div>
    </div>

    <!-- AI ç¡®è®¤å¼¹å±‚ -->
    <div id="ai-modal" class="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 hidden flex items-end">
      <div class="bg-white dark:bg-neutral-800 w-full rounded-t-2xl max-h-[80vh] overflow-y-auto">
        <div class="flex justify-between items-center p-6 border-b border-neutral-200 dark:border-neutral-700">
          <button id="cancel-ai" class="text-neutral-500 dark:text-neutral-400 touch-target">å–æ¶ˆ</button>
          <button id="confirm-ai" class="px-5 py-2 bg-primary text-white rounded-xl text-sm font-medium touch-target">ç¡®è®¤</button>
        </div>
        <div class="p-5 border-b border-neutral-200 dark:border-neutral-700">
          <div class="flex justify-center space-x-4 overflow-x-auto scrollbar-hide pb-3">
            <img id="ai-preview-img" class="w-48 h-48 rounded-xl object-cover hidden" alt="é¢„è§ˆ" />
          </div>
        </div>
        <div class="p-5 border-b border-neutral-200 dark:border-neutral-700">
          <div class="flex items-center justify-between mb-2">
            <h3 class="text-sm font-medium">AI è¯†åˆ«ç»“æœ</h3>
            <div class="text-xs text-neutral-500">
              <span>é¤æ¬¡ï¼š</span>
              <span id="ai-meal-label" class="px-2 py-0.5 rounded bg-neutral-900 text-white dark:bg-neutral-200 dark:text-neutral-900">â€”</span>
              <button id="ai-meal-edit" class="ml-1 px-2 py-0.5 rounded border border-neutral-300 dark:border-neutral-600">æ”¶èµ·</button>
            </div>
          </div>
          <div id="ai-meal-selector" class="mb-3 overflow-x-auto scrollbar-hide">
            <div class="flex space-x-2">
              <button type="button" data-meal="breakfast" class="ai-meal-chip px-3 py-1.5 rounded-lg text-xs bg-neutral-100 dark:bg-neutral-700">æ—©é¤</button>
              <button type="button" data-meal="lunch" class="ai-meal-chip px-3 py-1.5 rounded-lg text-xs bg-neutral-100 dark:bg-neutral-700">åˆé¤</button>
              <button type="button" data-meal="dinner" class="ai-meal-chip px-3 py-1.5 rounded-lg text-xs bg-neutral-100 dark:bg-neutral-700">æ™šé¤</button>
              <button type="button" data-meal="night" class="ai-meal-chip px-3 py-1.5 rounded-lg text-xs bg-neutral-100 dark:bg-neutral-700">å¤œå®µ</button>
              <button type="button" data-meal="snack" class="ai-meal-chip px-3 py-1.5 rounded-lg text-xs bg-neutral-100 dark:bg-neutral-700">åŠ é¤</button>
            </div>
          </div>
          <div id="ai-table" class="space-y-2 text-sm text-neutral-700 dark:text-neutral-300">
            <!-- åŠ¨æ€å¡«å…… -->
          </div>
          <div class="flex justify-between items-center mt-3">
            <div class="font-bold text-sm">åˆè®¡</div>
            <div id="ai-total" class="text-xl font-bold text-primary">0kcal</div>
          </div>
        </div>
        <div class="p-5">
          <div class="flex items-center space-x-3">
            <input id="ai-correction" class="flex-1 p-3 bg-neutral-100 dark:bg-neutral-700 rounded-full text-sm focus:outline-none focus:ring-2 focus:ring-primary/30" placeholder="ä¾‹å¦‚ï¼šæ²¡æœ‰è–¯æ¡ã€åªè¦æ±‰å ¡ã€å¤šä¸€ä»½ç±³é¥­" type="text"/>
            <button id="ai-send" class="w-10 h-10 rounded-full bg-primary flex items-center justify-center text-white touch-target"><i class="fa-solid fa-paper-plane text-xs"></i></button>
          </div>
        </div>
      </div>
    </div>
    <!-- é€‰æ‹©å›¾ç‰‡æ¥æºå¼¹å±‚ -->
    <div id="pick-photo-modal" class="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 hidden items-end">
      <div class="bg-white dark:bg-neutral-800 w-full rounded-t-2xl overflow-hidden">
        <div class="p-4 border-b border-neutral-200 dark:border-neutral-700 text-center text-sm text-neutral-500">é€‰æ‹©å›¾ç‰‡æ¥æº</div>
        <div class="p-4 space-y-3">
          <button id="pick-camera" class="w-full py-3 bg-primary text-white rounded-xl font-medium">æ‹ç…§</button>
          <button id="pick-gallery" class="w-full py-3 bg-neutral-100 dark:bg-neutral-700 rounded-xl font-medium">ä»ç›¸å†Œé€‰æ‹©</button>
          <button id="pick-cancel" class="w-full py-3 rounded-xl border border-neutral-300 dark:border-neutral-600">å–æ¶ˆ</button>
        </div>
      </div>
    </div>

    <script>
      // iOS PWAï¼šä»åå°å›åˆ°å‰å°æ—¶ï¼Œè‹¥èšç„¦åœ¨è¾“å…¥æ¡†ï¼Œç³»ç»Ÿå¯èƒ½å¼¹å‡º"æ’¤é”€/å–æ¶ˆ"ï¼ˆShake to Undoï¼‰ã€‚
      // è§„é¿ï¼šå‰å°æ—¶ä¸»åŠ¨å–æ¶ˆè¾“å…¥ç„¦ç‚¹ï¼Œæ¸…ç©ºé€‰æ‹©ï¼Œé¿å…è§¦å‘ç³»ç»Ÿæ’¤é”€å¼¹æ¡†ã€‚
      (function mitigateIOSUndo(){
        const blurActive = ()=>{
          const el = document.activeElement;
          if(el && (el.tagName==='INPUT' || el.tagName==='TEXTAREA')){
            try{ el.blur(); }catch{}
          }
        };
        document.addEventListener('visibilitychange', ()=>{
          if(document.visibilityState==='visible') blurActive();
        });
        window.addEventListener('pageshow', blurActive);
        window.addEventListener('focus', blurActive);
      })();
      // è½»å­˜å‚¨åŠ©æ‰‹
      // === æ•°æ®æ¨¡å‹ ===
// MealItem: { name, grams, protein, carbs, fat, kcal }
// Meal: {
//   id, dateKey:'YYYY-MM-DD', time:number, mealType:'breakfast'|'lunch'|'dinner'|'snack'|'night',
//   source:'camera'|'text', text, items:MealItem[], totals:{kcal,protein,carbs,fat},
//   note:'', corrected:false, createdAt:number, updatedAt:number, backfill:boolean
// }
// User: { plan:'high'|'normal'|'low', goals:{cal,pro,fat,carb}, defaults:{...ä¸‰å¥—...}, isSubscribed:boolean, trialEnd:number }
// ======== é€šè¿‡Netlifyå‡½æ•°è°ƒç”¨é€šä¹‰åƒé—®API ========
// API Keyç°åœ¨é€šè¿‡ç¯å¢ƒå˜é‡å®‰å…¨å­˜å‚¨ï¼Œä¸å†æš´éœ²åœ¨å‰ç«¯ä»£ç ä¸­

// æç¤ºè¯é€»è¾‘ç”±åç«¯ç»Ÿä¸€ç»´æŠ¤

function calcTotals(items){
  if (window.SharedNutrition && SharedNutrition.calcTotals) {
    return SharedNutrition.calcTotals(items);
  }
  const t = items.reduce((a,i)=>{
    const p=+i.protein||0, c=+i.carbs||0, f=+i.fat||0;
    const k = Number.isFinite(+i.kcal) ? Math.max(0, Math.round(+i.kcal)) : Math.round(p*4+c*4+f*9);
    a.kcal+=k; a.protein+=p; a.carbs+=c; a.fat+=f; return a;
  }, {kcal:0,protein:0,carbs:0,fat:0});
  t.protein=+t.protein.toFixed(1); t.carbs=+t.carbs.toFixed(1); t.fat=+t.fat.toFixed(1);
  return t;
}
// === ç”Ÿæˆä¿å­˜ç”¨çš„ç®€è¿°æ–‡æ¡ˆï¼šå¦‚ "ç‰›è‚‰é¢ x 1ã€é¦™è•‰ x 1" ===
function formatMealText(items){
  if (!Array.isArray(items) || items.length === 0) return '';
  // å…ˆæŠŠåŒåé£Ÿç‰©åˆå¹¶ç»Ÿè®¡æ•°é‡ï¼ˆç›®å‰é»˜è®¤æ¯é¡¹ 1 ä»½ï¼‰
  const map = new Map();
  for (const it of items) {
    const name = String(it?.name || 'é£Ÿç‰©').trim();
    if (!name) continue;
    map.set(name, (map.get(name) || 0) + 1);
  }
  return Array.from(map.entries()).map(([name, cnt]) => `${name} x ${cnt}`).join('ã€');
}

async function callAI({ text=null, image=null, mode='auto', prevJSON=null }){
  console.log('è°ƒç”¨é€šä¹‰åƒé—®API...', { text: text?.substring(0, 100), hasImage: !!image, mode });
  
  // è°ƒç”¨Netlifyå‡½æ•°
  const response = await fetch('/.netlify/functions/call-ai', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json'
    },
    body: JSON.stringify({
      text,
      image,
      mode,
      prevJSON
    })
  });

  console.log('Netlifyå‡½æ•°å“åº”çŠ¶æ€:', response.status);

  if (!response.ok) {
    const errorText = await response.text();
    console.error('Netlifyå‡½æ•°é”™è¯¯:', errorText);
    throw new Error(`APIè°ƒç”¨å¤±è´¥ (${response.status}): ${errorText}`);
  }

  const result = await response.json();
  console.log('Netlifyå‡½æ•°è¿”å›æ•°æ®:', result);

  if (result.error) {
    throw new Error(`APIè¿”å›é”™è¯¯: ${result.error}`);
  }

  return result;
}
const dateKeyOf = (ts)=> {
  const d = new Date(ts);
  if (window.SharedDate && SharedDate.formatYMD) return SharedDate.formatYMD(d);
  const two=n=>n<10?'0'+n:''+n; return `${d.getFullYear()}-${two(d.getMonth()+1)}-${two(d.getDate())}`;
};
const uid = ()=> 'm_' + Math.random().toString(36).slice(2,9) + Date.now();
let editingOldMealKey = null;   // è‹¥ä¸ä¸º nullï¼Œåˆ™ç¡®è®¤æ—¶è¦†ç›–è¿™æ¡æ—§é¤
let tempAiItemsForEdit = null;  // æš‚å­˜ AI è¿”å›çš„æ¡ç›®ï¼ˆç¼–è¾‘æ¨¡å¼ï¼‰

      // â€”â€” ç›¸æœº/å›¾ç‰‡é€‰æ‹©éœ€è¦ç”¨åˆ°çš„å˜é‡ â€”â€” 
      
let selectedImageData = null;  // ç”¨æ¥ä¿å­˜é€‰åˆ°çš„å›¾ç‰‡ï¼ˆBase64ï¼‰
const aiModal = document.getElementById('ai-modal');
// â€”â€” æ¸…ç†ä¸€æ¬¡ä¼šè¯ï¼ˆç”¨äºå…³é—­å¼¹å±‚å’Œæ¯æ¬¡æ–°å¼€è¯†åˆ«å‰ï¼‰ â€”â€”
function resetAiSession(){
  window.__aiSession = null;
  // æ¸…ç©ºè¡¨æ ¼ä¸åˆè®¡
  const table = document.getElementById('ai-table');
  if (table) table.innerHTML = '';
  const total = document.getElementById('ai-total');
  if (total) total.textContent = '0kcal';
  // æ¸…ç©ºä¿®æ­£è¾“å…¥
  const corr = document.getElementById('ai-correction');
  if (corr) corr.value = '';
  // æ¸…æ‰é¢„è§ˆå›¾
  const preview = document.getElementById('ai-preview-img');
  if (preview){
    preview.src = '';
    preview.classList.add('hidden');
  }
  // æ¸…æ‰ä¸Šä¸€å¼ å›¾ç‰‡çš„ base64
  selectedImageData = null;
}
// å…³é—­ AI å¼¹å±‚ï¼šç‚¹"å–æ¶ˆ"/ç‚¹è’™å±‚/æŒ‰ ESC éƒ½èƒ½å…³
function closeAiModal(){ 
  aiModal.classList.add('hidden'); 
  resetAiSession(); 
  // æ¸…ç†ç¼–è¾‘çŠ¶æ€
  window.currentEditableItems = null;
}
document.getElementById('cancel-ai').onclick = closeAiModal;
aiModal.addEventListener('click', (e) => { if (e.target === aiModal) closeAiModal(); });
window.addEventListener('keydown', (e) => { if (e.key === 'Escape') closeAiModal(); });
const photoInput = document.getElementById('photo-input');
const galleryInput = document.getElementById('gallery-input');
// â€”â€” AIå¼¹å±‚ï¼šé¤æ¬¡æ˜¾ç¤ºä¸ä¿®æ”¹ â€”â€”
const AI_MEAL_I18N = { breakfast:'æ—©é¤', lunch:'åˆé¤', dinner:'æ™šé¤', night:'å¤œå®µ', snack:'åŠ é¤' };
function initAiMealControls(){
  try{
    const label = document.getElementById('ai-meal-label');
    const editBtn = document.getElementById('ai-meal-edit');
    const selector = document.getElementById('ai-meal-selector');
    if (!label || !editBtn || !selector) return;
    // å±•ç¤ºå½“å‰é¤æ¬¡ï¼Œå¹¶é»˜è®¤å±•å¼€é€‰æ‹©å™¨
    const nightEnabled = !!document.getElementById('night-snack')?.checked;
    const snackEnabled = !!document.getElementById('snack')?.checked;
    const meal = (currentMeal==='night' && !nightEnabled) ? 'dinner' : (currentMeal==='snack' && !snackEnabled ? 'dinner' : currentMeal);
    label.textContent = AI_MEAL_I18N[meal] || 'â€”';
    selector.classList.remove('hidden');
    editBtn.textContent = 'æ”¶èµ·';
    // æ ¹æ®å¼€å…³éšè—å¤œå®µ/åŠ é¤
    selector.querySelectorAll('.ai-meal-chip').forEach(btn=>{
      const type = btn.getAttribute('data-meal');
      const shouldHide = (type==='night' && !nightEnabled) || (type==='snack' && !snackEnabled);
      btn.classList.toggle('hidden', shouldHide);
      btn.classList.toggle('pointer-events-none', shouldHide);
    });
    // é«˜äº®å½“å‰
    selector.querySelectorAll('.ai-meal-chip').forEach(btn=>{
      const type = btn.getAttribute('data-meal');
      btn.classList.remove('bg-primary','text-white');
      btn.classList.add('bg-neutral-100','dark:bg-neutral-700');
      if (type===meal){
        btn.classList.remove('bg-neutral-100','dark:bg-neutral-700');
        btn.classList.add('bg-primary','text-white');
      }
    });
    // äº¤äº’
    editBtn.onclick = ()=>{ 
      selector.classList.toggle('hidden');
      editBtn.textContent = selector.classList.contains('hidden') ? 'ä¿®æ”¹' : 'æ”¶èµ·';
    };
    selector.querySelectorAll('.ai-meal-chip').forEach(btn=>{
      btn.onclick = ()=>{
        const t = btn.getAttribute('data-meal');
        setMeal(t);
        label.textContent = AI_MEAL_I18N[t] || 'â€”';
        // ä¿æŒå±•å¼€ï¼Œä»…æ›´æ–°é«˜äº®
        selector.querySelectorAll('.ai-meal-chip').forEach(b=>{
          const tp = b.getAttribute('data-meal');
          b.classList.remove('bg-primary','text-white');
          b.classList.add('bg-neutral-100','dark:bg-neutral-700');
          if (tp===t){ b.classList.remove('bg-neutral-100','dark:bg-neutral-700'); b.classList.add('bg-primary','text-white'); }
        });
      };
    });
  }catch(e){ console.warn('initAiMealControls failed', e); }
}
// å›¾ç‰‡å‹ç¼©å‡½æ•°
function compressImage(file, maxSizeMB = 2) {
  return new Promise((resolve) => {
    const canvas = document.createElement('canvas');
    const ctx = canvas.getContext('2d');
    const img = new Image();
    
    img.onload = () => {
      // è®¡ç®—å‹ç¼©å°ºå¯¸
      let { width, height } = img;
      const maxDimension = 1024; // æœ€å¤§è¾¹é•¿
      
      if (width > height && width > maxDimension) {
        height = (height * maxDimension) / width;
        width = maxDimension;
      } else if (height > maxDimension) {
        width = (width * maxDimension) / height;
        height = maxDimension;
      }
      
      canvas.width = width;
      canvas.height = height;
      
      // ç»˜åˆ¶å‹ç¼©åçš„å›¾ç‰‡
      ctx.drawImage(img, 0, 0, width, height);
      
      // è·å–å‹ç¼©åçš„base64ï¼Œè´¨é‡ä»0.8å¼€å§‹é€’å‡
      let quality = 0.8;
      let compressedData;
      
      do {
        compressedData = canvas.toDataURL('image/jpeg', quality);
        quality -= 0.1;
      } while (compressedData.length > maxSizeMB * 1024 * 1024 * 1.37 && quality > 0.1); // base64æ¯”åŸæ–‡ä»¶å¤§çº¦37%
      
      resolve(compressedData);
    };
    
    const reader = new FileReader();
    reader.onload = (e) => {
      img.src = e.target.result;
    };
    reader.readAsDataURL(file);
  });
}

// ç›‘å¬å›¾ç‰‡é€‰æ‹©ï¼šåªèµ°"å›¾ç‰‡é€šè·¯"ï¼Œå¹¶æ¸…ç©ºæ–‡å­—é¿å…æ··å…¥
photoInput.addEventListener('change', async (e) => {
  const file = e.target.files && e.target.files[0];
  if (!file) return;

  try {
    // å‹ç¼©å›¾ç‰‡
    selectedImageData = await compressImage(file);
    console.log('åŸå§‹æ–‡ä»¶å¤§å°:', (file.size / 1024 / 1024).toFixed(2), 'MB');
    console.log('å‹ç¼©åå¤§å°:', (selectedImageData.length / 1024 / 1024 * 0.75).toFixed(2), 'MB');

    const corr = document.getElementById('ai-correction');
    if (corr) corr.value = '';

    // å…³é”®ï¼šæ¸…ç©ºæ–‡å­—ï¼Œç¡®ä¿ä¸æŠŠä¸Šä¸€æ¬¡æˆ–å½“å‰æ–‡å­—å¤¹å¸¦åˆ°å›¾ç‰‡è¯†åˆ«
    const mealInput = document.getElementById('meal-text');
    if (mealInput) mealInput.value = '';

    const previewEl = document.getElementById('ai-preview-img');
    if (previewEl) {
      previewEl.src = selectedImageData;
      previewEl.classList.remove('hidden');
    }

    aiModal.classList.remove('hidden');
    initAiMealControls();
    runAOnce(); // ä»…å›¾ç‰‡ +ï¼ˆå¯é€‰ï¼‰ä¿®æ­£
  } catch (error) {
    console.error('å›¾ç‰‡å¤„ç†å¤±è´¥:', error);
    showToast('å›¾ç‰‡å¤„ç†å¤±è´¥ï¼Œè¯·é‡è¯•');
  }
});
// ç›¸å†Œé€‰æ‹©ï¼šä¸æ‹ç…§ç›¸åŒçš„å¤„ç†æµç¨‹
galleryInput.addEventListener('change', async (e) => {
  const file = e.target.files && e.target.files[0];
  if (!file) return;

  try {
    selectedImageData = await compressImage(file);
    const corr = document.getElementById('ai-correction');
    if (corr) corr.value = '';
    const mealInput = document.getElementById('meal-text');
    if (mealInput) mealInput.value = '';
    const previewEl = document.getElementById('ai-preview-img');
    if (previewEl) {
      previewEl.src = selectedImageData;
      previewEl.classList.remove('hidden');
    }
    aiModal.classList.remove('hidden');
    initAiMealControls();
    runAOnce();
  } catch (error) {
    console.error('å›¾ç‰‡å¤„ç†å¤±è´¥:', error);
    showToast('å›¾ç‰‡å¤„ç†å¤±è´¥ï¼Œè¯·é‡è¯•');
  }
});
      const store = {
        get(key, def){ try{ return JSON.parse(localStorage.getItem(key)) ?? def }catch{ return def } },
        set(key, val){ localStorage.setItem(key, JSON.stringify(val)) }
      }
      function ymdKey(d=new Date()){
  if (window.SharedDate && SharedDate.formatYMD) return SharedDate.formatYMD(d);
  const two = n => n<10?'0'+n:''+n; return `${d.getFullYear()}-${two(d.getMonth()+1)}-${two(d.getDate())}`;
}

// â€”â€” ä¸‰å¥—é¢„è®¾ + å½“å‰æ¨¡å¼ â€”â€”
// ç»“æ„ï¼šgoalPresets = { high:{cal,pro,fat}, normal:{...}, low:{...} }
function getGoalPresets(){
  const saved = store.get('goalPresets', null);
  if (saved) return saved;
  const def = {
    high:   { cal:2500, pro:120, fat:80 },
    normal: { cal:2000, pro:100, fat:65 },
    low:    { cal:1500, pro: 80, fat:50 },
  };
  store.set('goalPresets', def);
  return def;
}
function setGoalPresets(p){ store.set('goalPresets', p); }

// å½“å‰æ¨¡å¼ï¼šhigh/normal/lowï¼ˆé»˜è®¤ normalï¼‰
function getCurrentMode(){ return store.get('currentMode', 'normal'); }
function setCurrentMode(m){ store.set('currentMode', m); }

// ä¸ªäººèµ„æ–™ï¼šä¿ç•™ä½ åŸæœ‰ç»“æ„
function getProfile(){
  return store.get('profile', { name:'æœªè®¾ç½®', gender:'ç”·', age:30, height:175, weight:70 });
}
function setProfile(p){ store.set('profile', p); }

// é¦–é¡µï¼šæŒ‰"å½“å‰æ¨¡å¼"æŠŠé¢„è®¾çŒå…¥ä»Šå¤©ï¼ˆå¯æ‰‹åŠ¨æ”¹ï¼‰
function loadGoalsForToday(){
  const today = ymdKey();
  const todayGoals = store.get('todayGoals', null);
  const presets = getGoalPresets();
  const mode = getCurrentMode();
  const base = presets[mode] || presets.normal;

  const g = (todayGoals && todayGoals.date===today)
    ? todayGoals
    : { date:today, ...base };

  document.getElementById('goal-cal').value = g.cal;
  document.getElementById('goal-pro').value = g.pro;
  document.getElementById('goal-fat').value = g.fat;
  store.set('todayGoals', g);
  syncGoalLabels();
}
function getTargetCarbs(cal, pro, fat){
  try{
    const presets = getGoalPresets();
    const mode = getCurrentMode();
    const presetCarbs = presets && presets[mode] ? +presets[mode].carbs : NaN;
    if (Number.isFinite(presetCarbs) && presetCarbs >= 0) return Math.round(presetCarbs);
  }catch{}
  if (window.SharedNutrition && SharedNutrition.getTargetCarbs) {
    return SharedNutrition.getTargetCarbs(cal, pro, fat);
  }
  let carbs = Math.round((cal - pro*4 - fat*9) / 4);
  if (!isFinite(carbs) || carbs < 0) carbs = 0;
  return carbs;
}

// æ‰‹åŠ¨æ”¹äº†é¦–é¡µæ•°å­—æ—¶ï¼Œä¿å­˜"ä»Šå¤©è¦†ç›–"
function saveTodayOverride(){
  const g = {
    date: ymdKey(),
    cal: +document.getElementById('goal-cal').value || 2000,
    pro: +document.getElementById('goal-pro').value || 100,
    fat: +document.getElementById('goal-fat').value || 65,
  };
  store.set('todayGoals', g);
}



     // ä¸»é¢˜æ¨¡å¼ï¼šauto | light | dark
// - autoï¼šæŒ‰æ—¶é—´åˆ‡ï¼ˆ19:00â€“06:00 = darkï¼‰
// - light/darkï¼šæ‰‹åŠ¨å›ºå®šï¼ˆæ”¯æŒâ€œä¸´æ—¶åˆ°æœŸè‡ªåŠ¨æ¢å¤â€ï¼‰
function computeShouldDark(d){
  const h = (d || new Date()).getHours();
  return (h >= 19 || h < 6);
}

function getNextThresholdTime(from){
  const now = from ? new Date(from) : new Date();
  const t = new Date(now);
  t.setMinutes(0,0,0);
  const h = now.getHours();
  if (h < 6) {
    t.setHours(6);
  } else if (h < 19) {
    t.setHours(19);
  } else {
    t.setDate(t.getDate()+1);
    t.setHours(6);
  }
  return t;
}

function formatHHmm(d){
  const hh = String(d.getHours()).padStart(2,'0');
  const mm = String(d.getMinutes()).padStart(2,'0');
  return hh + ':' + mm;
}

function getManualUntil(){
  const v = +localStorage.getItem('manualUntil');
  return Number.isFinite(v) && v > 0 ? v : 0;
}
function setManualUntil(ts){
  if (ts && Number.isFinite(ts)) localStorage.setItem('manualUntil', String(ts));
  else localStorage.removeItem('manualUntil');
}

function applyThemeByMode(mode){
  if(mode==='auto'){
    const shouldDark = computeShouldDark();
    document.documentElement.classList.toggle('dark', shouldDark);
    localStorage.setItem('theme', shouldDark ? 'dark' : 'light');
  }else{
    document.documentElement.classList.toggle('dark', mode==='dark');
    localStorage.setItem('theme', mode);
  }
  updateThemeColorMeta();
}

function updateThemeColorMeta(){
  const meta = document.getElementById('meta-theme-color-runtime');
  if(!meta) return;
  const isDark = document.documentElement.classList.contains('dark');
  meta.setAttribute('content', isDark ? '#111827' : '#FFFFFF');
}

function getThemeMode(){
  return localStorage.getItem('themeMode') || 'auto';
}
function setThemeMode(mode){
  localStorage.setItem('themeMode', mode);
  applyThemeByMode(mode);
  scheduleThemeTimer();
}

function scheduleThemeTimer(){
  clearTimeout(window.__themeTimer);
  window.__themeTimer = null;
  const mode = getThemeMode();
  let targetTime = null;

  if (mode === 'auto') {
    targetTime = getNextThresholdTime();
  } else {
    const mu = getManualUntil();
    if (mu) {
      const now = Date.now();
      if (now >= mu) {
        // æ‰‹åŠ¨å·²è¿‡æœŸ â†’ ç«‹å³æ¢å¤è‡ªåŠ¨
        setManualUntil(0);
        setThemeMode('auto');
        showToast('å·²æ¢å¤è‡ªåŠ¨æ¨¡å¼');
        return;
      }
      targetTime = new Date(mu);
    }
  }

  if (!targetTime) return;
  const delay = Math.max(0, targetTime.getTime() - Date.now());
  window.__themeTimer = setTimeout(()=>{
    const cur = getThemeMode();
    if (cur === 'auto') {
      // åˆ°é˜ˆå€¼æ—¶è‡ªåŠ¨æŒ‰æ—¶é—´åˆ‡æ¢
      applyThemeByMode('auto');
      scheduleThemeTimer();
    } else {
      // æ‰‹åŠ¨è¦†ç›–åˆ°æœŸ â†’ æ¢å¤è‡ªåŠ¨
      setManualUntil(0);
      setThemeMode('auto');
      showToast('å·²æ¢å¤è‡ªåŠ¨æ¨¡å¼');
    }
  }, delay);
}

// ç»‘å®šæŒ‰é’®ï¼šç‚¹å‡» = åœ¨ light/dark ä¹‹é—´åˆ‡æ¢å¹¶è¿›å…¥â€œæ‰‹åŠ¨è‡³ä¸‹ä¸ªé˜ˆå€¼â€ï¼›é•¿æŒ‰ 1.5s æ¢å¤ auto
const themeToggle = document.getElementById('theme-toggle');
let pressTimer = null;
themeToggle.addEventListener('mousedown', ()=>{ pressTimer = setTimeout(()=> { setManualUntil(0); setThemeMode('auto'); showToast('å·²æ¢å¤è‡ªåŠ¨æ¨¡å¼'); }, 1500); });
themeToggle.addEventListener('mouseup', ()=> clearTimeout(pressTimer));
themeToggle.addEventListener('mouseleave', ()=> clearTimeout(pressTimer));
themeToggle.addEventListener('click', () => {
  // å¦‚æœå½“å‰åœ¨ autoï¼Œåˆ™ä»¥å½“å‰å®é™… class ä¸ºåŸºå‡†åˆ‡åˆ°å¦ä¸€ç§ï¼Œå¹¶è¿›å…¥æ‰‹åŠ¨
  const curMode = getThemeMode();
  const isDark = document.documentElement.classList.contains('dark');
  const nextMode = (curMode==='auto' ? (isDark?'light':'dark') : (localStorage.getItem('theme')==='dark' ? 'light':'dark'));
  const until = getNextThresholdTime();
  setManualUntil(until.getTime());
  setThemeMode(nextMode);
  showToast(`å·²åˆ‡æ¢ä¸º${nextMode==='dark'?'æ·±è‰²':'æµ…è‰²'}ï¼ˆæ‰‹åŠ¨è‡³ ${formatHHmm(until)}ï¼‰`);
  const st = window.__chartState || {};
  // ä»…å½“å†å²é¡µå›¾è¡¨åœ¨ DOM ä¸­æ—¶æ‰åˆ·æ–°å›¾è¡¨é…è‰²
  if (document.getElementById('metrics-chart')) {
    initChart(st.metric || 'calories', historyView, periodStart, selectedDate);
  }
});

// å¯åŠ¨æ—¶åº”ç”¨ + å®šæ—¶åˆ°é˜ˆå€¼
// è‹¥æ‰‹åŠ¨æ¨¡å¼ä¸”å·²è¿‡æœŸï¼Œç«‹å³æ¢å¤è‡ªåŠ¨
(function initTheme(){
  const mode = getThemeMode();
  if (mode === 'auto') {
    applyThemeByMode('auto');
  } else {
    const mu = getManualUntil();
    if (mu && Date.now() >= mu) {
      setManualUntil(0);
      setThemeMode('auto');
      showToast('å·²æ¢å¤è‡ªåŠ¨æ¨¡å¼');
    } else {
      applyThemeByMode(mode);
    }
  }
  scheduleThemeTimer();
})();

// å›åˆ°å‰å°æ—¶æ ¡æ­£ä¸€æ¬¡ï¼ˆåº”å¯¹ç¡çœ /è·¨å¤©ï¼‰
document.addEventListener('visibilitychange', ()=>{
  if (document.visibilityState === 'visible') {
    const mode = getThemeMode();
    if (mode === 'auto') {
      applyThemeByMode('auto');
      scheduleThemeTimer();
    } else {
      const mu = getManualUntil();
      if (mu && Date.now() >= mu) {
        setManualUntil(0);
        setThemeMode('auto');
        showToast('å·²æ¢å¤è‡ªåŠ¨æ¨¡å¼');
      } else {
        applyThemeByMode(mode);
        scheduleThemeTimer();
      }
    }
  }
});

// åˆæ¬¡æ¸²æŸ“ä¹ŸåŒæ­¥ <meta name="theme-color">
updateThemeColorMeta();

      // é¡¶éƒ¨æ ‡é¢˜ä¸åˆ†åŒºåˆ‡æ¢
      const appTitle = document.getElementById('app-title');
      const pages = {
  today:    document.getElementById('page-today'),
  history:  document.getElementById('page-history'),
  profile:  document.getElementById('page-profile'),
  settingsProfile: document.getElementById('page-settings-profile'),
  settingsGoals:   document.getElementById('page-settings-goals'),
};
      function switchTab(tab){
        Object.values(pages).forEach(el => el.classList.add('hidden'));
        pages[tab].classList.remove('hidden');
        window.currentTab = tab;

        if (tab==='today')  appTitle.textContent = 'é£Ÿåˆ» Foodtime';
if (tab==='history'){ appTitle.textContent = 'å†å²è®°å½•'; initHistory(); }
if (tab==='profile') appTitle.textContent = 'æˆ‘çš„';
if (tab==='settingsProfile') appTitle.textContent = 'ä¸ªäººèµ„æ–™';
if (tab==='settingsGoals')   appTitle.textContent = 'è¥å…»ç›®æ ‡é¢„è®¾';

        // åº•éƒ¨é«˜äº®ï¼ˆä»…ä¸‰å¤§é¡µå‚ä¸é«˜äº®ï¼‰
        document.querySelectorAll('nav button').forEach(b=>b.classList.remove('text-primary'));
        if (['today','history','profile'].includes(tab)) {
          document.getElementById('tab-'+tab).classList.add('text-primary');
        }
      }
     // â€”â€” è®¾ç½®é¡µï¼šåŠ è½½/ä¿å­˜ï¼ˆæ‹†æˆä¸¤å¥—ï¼‰ â€”â€”

// ä¸ªäººèµ„æ–™ï¼šæŠŠæœ¬åœ°æ•°æ® â†’ è¡¨å•
function loadProfileForm(){
  const p = getProfile();
  document.getElementById('f-name').value   = p.name || '';
  document.getElementById('f-gender').value = p.gender || '';
  document.getElementById('f-age').value    = p.age || '';
  document.getElementById('f-height').value = p.height || '';
  document.getElementById('f-weight').value = p.weight || '';
}

// ä¸ªäººèµ„æ–™ï¼šä¿å­˜è¡¨å• â†’ æœ¬åœ° & åˆ·æ–°"æˆ‘çš„"å’Œé¦–é¡µ
function saveProfileForm(){
  const p = {
    name:   (document.getElementById('f-name').value || '').trim() || 'å¥åº·é¥®é£Ÿè€…',
    gender: (document.getElementById('f-gender').value || '').trim() || 'ç”·',
    age:    +document.getElementById('f-age').value || 32,
    height: +document.getElementById('f-height').value || 175,
    weight: +document.getElementById('f-weight').value || 70,
  };
  setProfile(p);

  // æ›´æ–°"æˆ‘çš„"å±•ç¤º
  document.getElementById('profile-name').textContent = p.name;
  document.getElementById('profile-basic').textContent = (p.gender||'') + (p.age?` ${p.age}å²`:'');
  document.getElementById('profile-body').textContent  = (p.height?`${p.height}cm`:'') + (p.weight?` / ${p.weight}kg`:'');
}

// è¥å…»ç›®æ ‡ï¼šæŠŠæœ¬åœ°æ•°æ® â†’ è¡¨å•
function loadGoalForm(){
  const gs = getGoalPresets();
  const fill = (prefix, set)=>{
    const calEl = document.getElementById(prefix+'-cal');
    const proEl = document.getElementById(prefix+'-pro');
    const fatEl = document.getElementById(prefix+'-fat');
    const carbEl = document.getElementById(prefix+'-carb');
    if (calEl) calEl.value = set.cal;
    if (proEl) proEl.value = set.pro;
    if (fatEl) fatEl.value = set.fat;
    if (carbEl) carbEl.value = set.carbs || Math.max(0, Math.round((set.cal - set.pro*4 - set.fat*9)/4));
  };
  fill('g-high', gs.high);
  fill('g-normal', gs.normal);
  fill('g-low', gs.low);
}

// è¥å…»ç›®æ ‡ï¼šä¿å­˜è¡¨å• â†’ æœ¬åœ° & åˆ·æ–°é¦–é¡µæ˜¾ç¤º
function saveGoalForm(){
  // å…ˆå–åŸæœ‰é¢„è®¾ï¼Œé¿å…è¦†ç›– high/low
  const prev = getGoalPresets();
  const gs = {
    high:   { cal:+(document.getElementById('g-high-cal')?.value)|| prev.high.cal,
              pro:+(document.getElementById('g-high-pro')?.value)|| prev.high.pro,
              fat:+(document.getElementById('g-high-fat')?.value)|| prev.high.fat,
              carbs:+(document.getElementById('g-high-carb')?.value) || Math.max(0, Math.round(((+document.getElementById('g-high-cal')?.value||prev.high.cal) - ((+document.getElementById('g-high-pro')?.value||prev.high.pro)*4) - ((+document.getElementById('g-high-fat')?.value||prev.high.fat)*9))/4)) },
    normal: { cal:+(document.getElementById('g-normal-cal')?.value)|| prev.normal.cal,
              pro:+(document.getElementById('g-normal-pro')?.value)|| prev.normal.pro,
              fat:+(document.getElementById('g-normal-fat')?.value)|| prev.normal.fat,
              carbs:+(document.getElementById('g-normal-carb')?.value) || Math.max(0, Math.round(((+document.getElementById('g-normal-cal')?.value||prev.normal.cal) - ((+document.getElementById('g-normal-pro')?.value||prev.normal.pro)*4) - ((+document.getElementById('g-normal-fat')?.value||prev.normal.fat)*9))/4)) },
    low:    { cal:+(document.getElementById('g-low-cal')?.value)|| prev.low.cal,
              pro:+(document.getElementById('g-low-pro')?.value)|| prev.low.pro,
              fat:+(document.getElementById('g-low-fat')?.value)|| prev.low.fat,
              carbs:+(document.getElementById('g-low-carb')?.value) || Math.max(0, Math.round(((+document.getElementById('g-low-cal')?.value||prev.low.cal) - ((+document.getElementById('g-low-pro')?.value||prev.low.pro)*4) - ((+document.getElementById('g-low-fat')?.value||prev.low.fat)*9))/4)) },
  };
  setGoalPresets(gs);     // â† å†™å›
  loadGoalsForToday();    // â† ç”¨å½“å‰æ¨¡å¼çŒå…¥"ä»Šæ—¥"
  syncGoalLabels();       // â† åˆ·æ–°"é¦–é¡µ"å’Œ"æˆ‘çš„"å±•ç¤º
  updateStats();          // â† è¿›åº¦æ¡/å‰©ä½™
}

// æ‰“å¼€ä¸¤ç§è®¾ç½®é¡µ
function showProfileSettings(){ loadProfileForm(); switchTab('settingsProfile'); }
function showGoalSettings(){ loadGoalForm(); switchTab('settingsGoals'); }

// "æˆ‘çš„"é¡µæŠŠå·²ä¿å­˜èµ„æ–™æ¸²æŸ“å‡ºæ¥
function loadProfile(){
  const p = getProfile();
  document.getElementById('profile-name').textContent = p.name || 'å¥åº·é¥®é£Ÿè€…';
  document.getElementById('profile-basic').textContent = (p.gender||'') + (p.age?` ${p.age}å²`:'');
  document.getElementById('profile-body').textContent  = (p.height?`${p.height}cm`:'') + (p.weight?` / ${p.weight}kg`:'');
}
// åˆæ¬¡åŠ è½½å¤´åƒ
function loadAvatar(){
  const p = getProfile();
  if (p.avatar) {
    const avatarEl = document.getElementById('profile-avatar');
    if (avatarEl) avatarEl.src = p.avatar;
  }
}

// ä¸Šä¼ å¤´åƒé€»è¾‘
document.getElementById('avatar-upload').addEventListener('change', (e)=>{
  const file = e.target.files?.[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = ev => {
    const base64 = ev.target.result;
    const profile = getProfile();
    profile.avatar = base64;
    setProfile(profile);
    const avatarEl = document.getElementById('profile-avatar');
    if (avatarEl) avatarEl.src = base64;
  };
  reader.readAsDataURL(file);
});
// ç»‘å®šæŒ‰é’®ï¼šè¿”å›/ä¿å­˜ï¼ˆä¸¤ä¸ªå­é¡µï¼‰
document.getElementById('settings-back-profile').onclick = ()=> switchTab('profile');
document.getElementById('settings-save-profile').onclick = ()=>{
  saveProfileForm();
  alert('å·²ä¿å­˜');
  switchTab('profile');
};
document.getElementById('settings-back-goal').onclick = ()=> switchTab('profile');
document.getElementById('settings-save-goal').onclick = ()=>{
  saveGoalForm();
  alert('å·²ä¿å­˜');
  switchTab('profile');
};

// "æˆ‘çš„"é¡µå…¥å£ï¼šåˆ†åˆ«è¿›å…¥ä¸¤ä¸ªå­é¡µ
document.getElementById('profile-edit').onclick     = () => showProfileSettings();
document.getElementById('profile-goal-btn').onclick = () => showGoalSettings();
      document.getElementById('tab-today').onclick = ()=>switchTab('today');
      document.getElementById('tab-history').onclick = ()=>switchTab('history');
      document.getElementById('tab-profile').onclick = ()=>switchTab('profile');

// ç»Ÿä¸€æŒ‰é’®æŒ‰å‹æ‰‹æ„Ÿä¸è½»å¾®éœ‡åŠ¨åé¦ˆ
document.addEventListener('click', (e)=>{
  const t = e.target.closest('button');
  if(!t) return;
  try{ if(navigator.vibrate) navigator.vibrate(12); }catch{}
});

      // â€”â€” æ¨ªå‘æ»‘åŠ¨æ‰‹åŠ¿åˆ‡æ¢ï¼ˆä¸‰é¡µï¼‰ â€”â€”
      (function initSwipeTabs(){
        let startX = 0, startY = 0, isMoving = false;
        const threshold = 60; // è§¦å‘åˆ‡æ¢çš„æœ€å°ä½ç§»
        const restraint = 50; // Y æ–¹å‘å®¹å·®
        const container = document.body;
        container.addEventListener('touchstart', (e)=>{
          if(!e.touches || e.touches.length!==1) return;
          const t = e.touches[0];
          startX = t.clientX; startY = t.clientY; isMoving = true;
        }, {passive:true});
        container.addEventListener('touchmove', (e)=>{
          if(!isMoving) return;
        }, {passive:true});
        container.addEventListener('touchend', (e)=>{
          if(!isMoving) return; isMoving = false;
          const t = e.changedTouches && e.changedTouches[0];
          if(!t) return;
          const dx = t.clientX - startX;
          const dy = t.clientY - startY;
          if (Math.abs(dy) > restraint) return; // å‚ç›´æ»šåŠ¨ä¸è§¦å‘
          if (Math.abs(dx) < threshold) return;  // ä½ç§»ä¸è¶³
          const order = ['today','history','profile'];
          const cur = window.currentTab || 'today';
          const idx = order.indexOf(cur);
          if (dx < 0 && idx < order.length-1) {
            // å·¦æ»‘ â†’ ä¸‹ä¸€é¡µ
            switchTab(order[idx+1]);
          } else if (dx > 0 && idx > 0) {
            // å³æ»‘ â†’ ä¸Šä¸€é¡µ
            switchTab(order[idx-1]);
          }
        }, {passive:true});
      })();
      document.getElementById('open-vip').onclick = () => {
  showToast('å³å°†å¼€é€šï¼Œæ•¬è¯·æœŸå¾…');
};
      // ============== ä»Šå¤©é¡µé€»è¾‘ ==============
      document.getElementById('current-date').textContent = ymdKey(new Date());

// æ¨¡å¼åˆ‡æ¢ï¼ˆä»é¢„è®¾è¯»å–ï¼‰
const modeButtons = document.querySelectorAll('[data-mode]');
modeButtons.forEach(btn=>{
  btn.addEventListener('click',()=>{
    modeButtons.forEach(b=>b.classList.remove('bg-white','dark:bg-neutral-600','shadow-sm'));
    btn.classList.add('bg-white','dark:bg-neutral-600','shadow-sm');

    const mode = btn.getAttribute('data-mode');    // high / normal / low
    setCurrentMode(mode);
    const presets = getGoalPresets()[mode] || getGoalPresets().normal;

    document.getElementById('goal-cal').value = presets.cal;
    document.getElementById('goal-pro').value = presets.pro;
    document.getElementById('goal-fat').value = presets.fat;

    syncGoalLabels();
    saveTodayOverride(); // åªå¯¹å½“å¤©ç”Ÿæ•ˆ
  })
});

// "é‡ç½®ç›®æ ‡" = ç”¨å½“å‰æ¨¡å¼çš„é¢„è®¾å›å¡«ä»Šå¤©
document.getElementById('reset-goal').onclick = ()=>{
  const mode = getCurrentMode();
  const base = getGoalPresets()[mode] || getGoalPresets().normal;
  document.getElementById('goal-cal').value = base.cal;
  document.getElementById('goal-pro').value = base.pro;
  document.getElementById('goal-fat').value = base.fat;
  syncGoalLabels();
  saveTodayOverride();
};
      
function syncGoalLabels(){
  const cal = +document.getElementById('goal-cal').value || 2000;
  const pro = +document.getElementById('goal-pro').value || 100;
  const fat = +document.getElementById('goal-fat').value || 65;

  const carbs = getTargetCarbs(cal, pro, fat);

  // â€”â€” é¦–é¡µå°å­—ï¼ˆç›®æ ‡ï¼‰â€”â€”
  document.getElementById('goal-pro-label').textContent  = pro;
  document.getElementById('goal-fat-label').textContent  = fat;
  const goalCarbsEl = document.getElementById('goal-carbs-label');
  if (goalCarbsEl) goalCarbsEl.textContent = carbs;

  // â€”â€” "æˆ‘çš„ â†’ è¥å…»ä¸ç›®æ ‡"ä¸€è¡Œï¼šå§‹ç»ˆæ˜¾ç¤ºã€Œç»´æŒã€é¢„è®¾ â€”â€”
  const ps = getGoalPresets();
  const normal = ps && ps.normal ? ps.normal : { cal:2000, pro:100, fat:65 };
  let nCarbs = normal.carbs || Math.round(((+normal.cal||0) - (+normal.pro||0)*4 - (+normal.fat||0)*9) / 4);
  if (!isFinite(nCarbs) || nCarbs < 0) nCarbs = 0;
  document.getElementById('profile-goal-cal').textContent   = normal.cal || 2000;
  document.getElementById('profile-goal-pro').textContent   = normal.pro || 100;
  document.getElementById('profile-goal-fat').textContent   = normal.fat || 65;
  const profCarbsEl = document.getElementById('profile-goal-carbs');
  if (profCarbsEl) profCarbsEl.textContent = nCarbs;

  // â€”â€” åˆ·æ–°ä»Šæ—¥ç»Ÿè®¡ï¼ˆè¿›åº¦æ¡/å‰©ä½™ç­‰ï¼‰â€”â€”
  updateStats();
}

      // å¤œå®µ/åŠ é¤å¼€å…³ -> chipæ˜¾ç¤º
      const nightToggle = document.getElementById('night-snack');
      const nightChip = document.getElementById('night-snack-chip');
      nightToggle.addEventListener('change', () => {
  const off = !nightToggle.checked;
  nightChip.classList.toggle('hidden', off);
  nightChip.classList.toggle('opacity-50', off);
  nightChip.classList.toggle('pointer-events-none', off);
  nightChip.disabled = off;
  // å¦‚æœå½“å‰é€‰ä¸­çš„æ˜¯å¤œå®µä½†è¢«å…³æ‰äº†ï¼Œé€€å›åˆ°"æ™šé¤"
  if (off && currentMeal === 'night') setMeal('dinner');
});
      const snackToggle = document.getElementById('snack');
      const snackChip = document.getElementById('snack-chip');
      snackToggle.addEventListener('change', () => {
  const off = !snackToggle.checked;
  snackChip.classList.toggle('hidden', off);
  snackChip.classList.toggle('opacity-50', off);
  snackChip.classList.toggle('pointer-events-none', off);
  snackChip.disabled = off;
  if (off && currentMeal === 'snack') setMeal('dinner');
});
// â€”â€” é¤æ¬¡é€‰æ‹© â€”â€”
// å½“å‰é€‰æ‹©çš„é¤æ¬¡ï¼šbreakfast / lunch / dinner / night / snack
let currentMeal = 'dinner';

const mealChipEls = {
  breakfast: document.getElementById('breakfast-chip'),
  lunch:     document.getElementById('lunch-chip'),
  dinner:    document.getElementById('dinner-chip'),
  night:     document.getElementById('night-snack-chip'),
  snack:     document.getElementById('snack-chip'),
};

function setMeal(meal) {
  currentMeal = meal;
  // æ¸…é™¤å…¨éƒ¨çš„"é€‰ä¸­æ ·å¼"
  Object.values(mealChipEls).forEach(el => {
    if (!el) return;
    el.classList.remove('bg-primary','text-white');
    // æ¢å¤æœªé€‰ä¸­çš„åŸºç¡€æ ·å¼
    if (!el.classList.contains('hidden')) {
      el.classList.add('bg-neutral-100','dark:bg-neutral-700');
    }
  });
  // ç»™å½“å‰é€‰ä¸­çš„åŠ é«˜äº®
  const el = mealChipEls[meal];
  if (el && !el.disabled) {
    el.classList.remove('bg-neutral-100','dark:bg-neutral-700');
    el.classList.add('bg-primary','text-white');
  }
}

// ç»‘å®šç‚¹å‡»
Object.entries(mealChipEls).forEach(([key, el]) => {
  if (!el) return;
  el.addEventListener('click', () => {
    if (el.disabled) return;
    setMeal(key);
  });
});

// æ ¹æ®æ—¶é—´è‡ªåŠ¨å®šä½é»˜è®¤é¤æ¬¡
function getDefaultMealByTime(){
  const hour = new Date().getHours();
  if (hour >= 5 && hour < 10) return 'breakfast';
  if (hour >= 10 && hour < 14) return 'lunch';
  if (hour >= 14 && hour < 21) return 'dinner';
  // æ·±å¤œï¼šè‹¥å¤œå®µå¼€å…³æœªå¼€å¯ï¼Œåˆ™å›é€€åˆ°æ™šé¤
  const nightEnabled = !!document.getElementById('night-snack')?.checked;
  return nightEnabled ? 'night' : 'dinner';
}

// åˆå§‹åŒ–ï¼šè‡ªåŠ¨é€‰æ‹©é»˜è®¤é¤æ¬¡
setMeal(getDefaultMealByTime());

      // å·²ç§»é™¤å¥åº·æ£€æŸ¥åŠŸèƒ½ï¼Œç›´æ¥è°ƒç”¨é€šä¹‰åƒé—®API

      // AI å¼¹å±‚
      // é€‰æ‹©å›¾ç‰‡æ¥æºå¼¹å±‚äº¤äº’
      const pickModal = document.getElementById('pick-photo-modal');
      function openPick(){ pickModal.classList.remove('hidden'); pickModal.classList.add('flex'); }
      function closePick(){ pickModal.classList.add('hidden'); pickModal.classList.remove('flex'); }
      document.getElementById('camera-btn').onclick = ()=> { openPick(); };
      document.getElementById('pick-camera').onclick = ()=> { closePick(); photoInput.click(); };
      document.getElementById('pick-gallery').onclick = ()=> { closePick(); galleryInput.click(); };
      document.getElementById('pick-cancel').onclick = ()=> { closePick(); };
      pickModal.addEventListener('click', (e)=>{ if(e.target===pickModal) closePick(); });
      document.getElementById('save-meal-btn').onclick = ()=>{
  // æ–‡å­—è¯†åˆ«å…¥å£ï¼šå½»åº•æ¸…æ‰ä¸Šä¸€å¼ å›¾ç‰‡çŠ¶æ€
  selectedImageData = null;
  const preview = document.getElementById('ai-preview-img');
  if (preview) {
    preview.src = '';
    preview.classList.add('hidden');
  }
  // æ¸…ç©ºä¸Šä¸€æ¬¡ä¿®æ­£å£ä»¤ï¼Œé¿å…ä¸²åœº
  const corr = document.getElementById('ai-correction');
  if (corr) corr.value = '';

  // æ‰“å¼€å¼¹çª—å¹¶æŒ‰"çº¯æ–‡å­—"æ‰§è¡Œä¸€æ¬¡
  aiModal.classList.remove('hidden');
  initAiMealControls();
  runAOnce();
};
      // "çº¸é£æœº"å‘é€ï¼šæŠŠä¿®æ­£è¯´æ˜å¸¦ä¸Šï¼Œå†è¯†åˆ«ä¸€æ¬¡å¹¶åˆ·æ–°è¡¨æ ¼
document.getElementById('ai-send').onclick = ()=>{
  const note = document.getElementById('ai-correction').value || '';
  if (note.trim()) {
    runAOnce(note);
  }
};

// ä¿®æ­£æŒ‡ä»¤è¾“å…¥æ¡†å›è½¦é”®æ”¯æŒ
document.getElementById('ai-correction').addEventListener('keypress', (e) => {
  if (e.key === 'Enter') {
    e.preventDefault();
    const note = e.target.value || '';
    if (note.trim()) {
      runAOnce(note);
    }
  }
});
// ç›‘å¬ç”¨æˆ·é€‰å›¾/æ‹ç…§
const previewEl = document.getElementById('ai-preview-img');
if (previewEl) {
  previewEl.src = selectedImageData || '';
  previewEl.classList.toggle('hidden', !selectedImageData);
}
// ä»…å½“æ˜¯æ‹ç…§/é€‰å›¾å…¥å£æ—¶æ‰æ‰“å¼€å¼¹å±‚
      // ç•™å¥½ Netlify ä¸­è½¬ã€Œå£å­ã€
// === ç³»ç»Ÿè§„åˆ™ï¼ˆä¼ ç»™åç«¯/å¤§æ¨¡å‹çš„ system æˆ–æ‹¼è¿› textï¼‰ ===
// â€”â€” æ¢å¤"ä¸¥æ ¼ JSON å¥‘çº¦"ï¼šitems + totals + notes â€”â€”
// è¯´æ˜ï¼škcal æ•´æ•°ï¼›å…¶ä½™ä¸€ä½å°æ•°ï¼›totals å¿…é¡»ä¸º items æ±‚å’Œï¼›ä¸­æ–‡èœå



// â€”â€” é€€é¿é‡è¯• â€”â€” 
async function withBackoff(doReq, tries=3, delay=6000){
  let lastErr;
  for (let i=0;i<tries;i++){
    try { return await doReq(); }
    catch(e){
      const msg = String(e?.message||"");
      const is429 = (e && e.status===429) || /rate limit/i.test(msg);
      lastErr = e;
      if (is429 && i < tries-1) await new Promise(r=>setTimeout(r,delay));
      else break;
    }
  }
  throw lastErr || new Error("request failed");
}

// â€”â€” ä¸¥æ ¼è§£æ + äºŒæ¬¡æ±‚å’Œå…œåº• â€”â€” 
function safeParseJSON(txt){
  try{
    const obj = JSON.parse(txt);
    const items = Array.isArray(obj.items)? obj.items.map(x=>({
      name: String(x.name||'é£Ÿç‰©'),
      kcal: Math.max(0, Math.round(Number(x.kcal)||0)),
      protein: Number(x.protein??0),
      fat: Number(x.fat??0),
      carbs: Number(x.carbs??0),
    })) : [];

    const totals = (window.SharedNutrition && SharedNutrition.calcTotals) ? SharedNutrition.calcTotals(items) : items.reduce((a,i)=>{
      const p=+i.protein||0, c=+i.carbs||0, f=+i.fat||0; const k=Number.isFinite(+i.kcal)?Math.max(0,Math.round(+i.kcal)):Math.round(p*4+c*4+f*9);
      a.kcal+=k; a.protein+=p; a.carbs+=c; a.fat+=f; return a;
    }, {kcal:0,protein:0,carbs:0,fat:0});
    totals.protein=+totals.protein.toFixed(1); totals.carbs=+totals.carbs.toFixed(1); totals.fat=+totals.fat.toFixed(1);

    const out = {
      items,
      totals,
      notes: typeof obj.notes==='string' ? obj.notes : ''
    };
    return out;
  }catch(e1){
    const m = txt && txt.match && txt.match(/\{[\s\S]*\}/);
    if (m) {
      try{
        return safeParseJSON(m[0]);
      }catch(e2){}
    }
    throw new Error('æ¨¡å‹è¿”å›æ ¼å¼å¼‚å¸¸ï¼šä¸æ˜¯åˆæ³•JSON');
  }
}




// â€”â€” ä¼šè¯æ€ï¼ˆå½“å‰å¼¹å±‚çš„ä¸€æ¬¡ä¼šè¯ï¼‰ï¼šä¿ç•™ lastJSON & å†å²æ¶ˆæ¯ â€”â€” 
// window.__aiSession = { lastJSON, messages: [{role:'assistant'|'user', payload|text, ts}], img?:string|null }


// â€”â€” æ¸²æŸ“è¯†åˆ«ç»“æœï¼ˆå¯ç¼–è¾‘ç‰ˆæœ¬ï¼šé€é¡¹ + åˆè®¡ + notesï¼‰ â€”â€” 
function renderAiResult(json){
  const wrap = document.getElementById('ai-table');
  wrap.innerHTML = '';
  const items = Array.isArray(json?.items) ? json.items : [];
  
  // å­˜å‚¨å½“å‰ç¼–è¾‘çš„æ•°æ®
  window.currentEditableItems = [...items];
  
  items.forEach((it, index)=>{
    const p=+(it.protein||0), c=+(it.carbs||0), f=+(it.fat||0);
    const kcal = Math.max(0, Math.round(+it.kcal||0));
    const row = document.createElement('div');
    row.className = 'p-3 rounded-xl bg-neutral-50 dark:bg-neutral-700 mb-2';
    row.innerHTML = `
      <div class="flex justify-between items-center mb-2">
        <div class="font-medium flex-1">${it.name || 'é£Ÿç‰©'}</div>
        <button class="ml-2 px-2 py-1 text-xs text-red-500 hover:bg-red-50 dark:hover:bg-red-900/20 rounded" 
                onclick="removeItem(${index})">åˆ é™¤</button>
      </div>
      <div class="grid grid-cols-2 gap-3 text-sm">
        <div>
          <label class="text-xs text-neutral-500 dark:text-neutral-400">å€ç‡è°ƒèŠ‚</label>
          <div class="flex items-center gap-2 mt-1">
            <button class="w-6 h-6 rounded bg-neutral-200 dark:bg-neutral-600 text-xs" 
                    onclick="adjustQuantity(${index}, 0.5)">-</button>
            <span class="quantity-display text-sm font-medium cursor-text" data-index="${index}" onclick="startEditQuantity(${index})">1.0å€</span>
            <button class="w-6 h-6 rounded bg-neutral-200 dark:bg-neutral-600 text-xs" 
                    onclick="adjustQuantity(${index}, 2)">+</button>
          </div>
        </div>
        <div class="text-right">
          <div class="text-lg font-medium kcal-display" data-index="${index}">${kcal} kcal</div>
          <div class="text-xs text-neutral-500 dark:text-neutral-400">
            è›‹ç™½ <span class="protein-display" data-index="${index}">${p.toFixed(1)}</span>g | 
            ç¢³æ°´ <span class="carbs-display" data-index="${index}">${c.toFixed(1)}</span>g | 
            è„‚è‚ª <span class="fat-display" data-index="${index}">${f.toFixed(1)}</span>g
          </div>
        </div>
      </div>
    `;
    wrap.appendChild(row);
  });

  updateTotalDisplay();

  // å¯é€‰ notes
  if (json?.notes) {
    const n = document.createElement('div');
    n.className = 'mt-2 text-xs text-neutral-500 dark:text-neutral-400';
    n.textContent = 'notesï¼š' + json.notes;
    wrap.appendChild(n);
  }
}

// â€”â€” ç¼–è¾‘åŠŸèƒ½ï¼šåˆ é™¤é£Ÿç‰©é¡¹ â€”â€”
function removeItem(index) {
  if (!window.currentEditableItems || index >= window.currentEditableItems.length) return;
  
  // ä»æ•°ç»„ä¸­åˆ é™¤è¯¥é¡¹
  window.currentEditableItems.splice(index, 1);
  
  // é‡æ–°æ¸²æŸ“
  const json = {
    items: window.currentEditableItems,
    totals: calcTotals(window.currentEditableItems),
    notes: ''
  };
  renderAiResult(json);
  
  // æ›´æ–°ä¼šè¯æ•°æ®
  if (window.__aiSession) {
    window.__aiSession.lastJSON = json;
  }
}

// â€”â€” ç¼–è¾‘åŠŸèƒ½ï¼šè°ƒèŠ‚ä»½é‡ â€”â€”
function adjustQuantity(index, multiplier) {
  if (!window.currentEditableItems || index >= window.currentEditableItems.length) return;
  
  const item = window.currentEditableItems[index];
  if (!item.originalValues) {
    // é¦–æ¬¡è°ƒèŠ‚æ—¶ä¿å­˜åŸå§‹å€¼
    item.originalValues = {
      protein: item.protein,
      carbs: item.carbs,
      fat: item.fat,
      kcal: item.kcal
    };
    item.currentMultiplier = 1.0;
  }
  
  // æ›´æ–°å€æ•°
  if (multiplier === 0.5) {
    item.currentMultiplier = Math.max(0.1, item.currentMultiplier - 0.1);
  } else if (multiplier === 2) {
    item.currentMultiplier = Math.min(5.0, item.currentMultiplier + 0.1);
  }
  
  // æ ¹æ®å€æ•°é‡æ–°è®¡ç®—è¥å…»æˆåˆ†
  const original = item.originalValues;
  item.protein = +(original.protein * item.currentMultiplier).toFixed(1);
  item.carbs = +(original.carbs * item.currentMultiplier).toFixed(1);
  item.fat = +(original.fat * item.currentMultiplier).toFixed(1);
  item.kcal = Math.round(original.kcal * item.currentMultiplier);
  
  // æ›´æ–°æ˜¾ç¤º
  updateItemDisplay(index, item);
  updateTotalDisplay();
  
  // æ›´æ–°ä¼šè¯æ•°æ®
  if (window.__aiSession) {
    window.__aiSession.lastJSON = {
      items: window.currentEditableItems,
      totals: calcTotals(window.currentEditableItems),
      notes: ''
    };
  }
}

// â€”â€” æ›´æ–°å•ä¸ªé£Ÿç‰©é¡¹çš„æ˜¾ç¤º â€”â€”
function updateItemDisplay(index, item) {
  const quantityEl = document.querySelector(`.quantity-display[data-index="${index}"]`);
  const kcalEl = document.querySelector(`.kcal-display[data-index="${index}"]`);
  const proteinEl = document.querySelector(`.protein-display[data-index="${index}"]`);
  const carbsEl = document.querySelector(`.carbs-display[data-index="${index}"]`);
  const fatEl = document.querySelector(`.fat-display[data-index="${index}"]`);
  
  if (quantityEl) quantityEl.textContent = `${item.currentMultiplier.toFixed(1)}å€`;
  if (kcalEl) kcalEl.textContent = `${item.kcal} kcal`;
  if (proteinEl) proteinEl.textContent = item.protein.toFixed(1);
  if (carbsEl) carbsEl.textContent = item.carbs.toFixed(1);
  if (fatEl) fatEl.textContent = item.fat.toFixed(1);
}

// â€”â€” æ‰‹åŠ¨ç¼–è¾‘å€æ•° â€”â€”
function startEditQuantity(index){
  if (!window.currentEditableItems || index >= window.currentEditableItems.length) return;
  const item = window.currentEditableItems[index];
  if (!item.originalValues) {
    item.originalValues = {
      protein: item.protein,
      carbs: item.carbs,
      fat: item.fat,
      kcal: item.kcal
    };
    item.currentMultiplier = 1.0;
  }
  const span = document.querySelector(`.quantity-display[data-index="${index}"]`);
  if (!span) return;

  // åˆ›å»ºè¾“å…¥æ¡†
  const currentVal = item.currentMultiplier || 1.0;
  const input = document.createElement('input');
  input.type = 'number';
  input.step = '0.1';
  input.min = '0.1';
  input.max = '5.0';
  input.value = currentVal.toFixed(1);
  input.className = 'w-16 text-center text-sm font-medium bg-white dark:bg-neutral-800 border border-neutral-300 dark:border-neutral-600 rounded px-2 py-0.5 outline-none';

  // æ›¿æ¢span
  span.replaceWith(input);
  input.focus();
  input.select();

  const apply = ()=>{
    let v = parseFloat(input.value);
    if (!isFinite(v)) v = currentVal;
    v = Math.max(0.1, Math.min(5.0, Math.round(v*10)/10));
    item.currentMultiplier = v;
    const original = item.originalValues;
    item.protein = +(original.protein * v).toFixed(1);
    item.carbs = +(original.carbs * v).toFixed(1);
    item.fat = +(original.fat * v).toFixed(1);
    item.kcal = Math.round(original.kcal * v);

    // è¿˜åŸæ˜¾ç¤ºèŠ‚ç‚¹
    const newSpan = document.createElement('span');
    newSpan.className = 'quantity-display text-sm font-medium cursor-text';
    newSpan.setAttribute('data-index', String(index));
    newSpan.textContent = `${v.toFixed(1)}å€`;
    newSpan.onclick = ()=> startEditQuantity(index);
    input.replaceWith(newSpan);

    updateItemDisplay(index, item);
    updateTotalDisplay();

    if (window.__aiSession) {
      window.__aiSession.lastJSON = {
        items: window.currentEditableItems,
        totals: calcTotals(window.currentEditableItems),
        notes: ''
      };
    }
  };

  const cancel = ()=>{
    // æ¢å¤span
    const newSpan = document.createElement('span');
    const v = item.currentMultiplier || 1.0;
    newSpan.className = 'quantity-display text-sm font-medium cursor-text';
    newSpan.setAttribute('data-index', String(index));
    newSpan.textContent = `${v.toFixed(1)}å€`;
    newSpan.onclick = ()=> startEditQuantity(index);
    input.replaceWith(newSpan);
  };

  input.addEventListener('keydown', (e)=>{
    if (e.key === 'Enter') { e.preventDefault(); apply(); }
    else if (e.key === 'Escape') { e.preventDefault(); cancel(); }
  });
  input.addEventListener('blur', ()=> apply());
}

// â€”â€” æ›´æ–°æ€»è®¡æ˜¾ç¤º â€”â€”
function updateTotalDisplay() {
  if (!window.currentEditableItems) return;
  
  const totals = calcTotals(window.currentEditableItems);
  const totalEl = document.getElementById('ai-total');
  if (totalEl) {
    totalEl.textContent = totals.kcal + 'kcal';
  }
}

// â€”â€” å•æ¬¡è¿è¡Œï¼šå›¾ç‰‡/æ–‡å­—é¦–è½®è¯†åˆ«ï¼›æˆ–åŸºäºä¸Šä¸€è½® JSON çš„"ä¿®æ­£" â€”â€” 
async function runAOnce(extraText){
  const baseText = (document.getElementById('meal-text')?.value || '').trim();
  const fixText  = (extraText || (document.getElementById('ai-correction')?.value||'')).trim();
  const hasImage = !!selectedImageData;

  // é¢„è§ˆ
  const preview = document.getElementById('ai-preview-img');
  if (preview) {
    if (hasImage) { preview.src = selectedImageData; preview.classList.remove('hidden'); }
    else { preview.src = ''; preview.classList.add('hidden'); }
  }

  const table = document.getElementById('ai-table');
  table.innerHTML = `<div class="text-sm text-neutral-500">è¯†åˆ«ä¸­...</div>`;
  document.getElementById('ai-total').textContent = '0kcal';

  try{
    let json;

    // ä¿®æ­£é€šè·¯ï¼šæœ‰ä¿®æ­£æ–‡å­—æŒ‡ä»¤
    if (fixText && (window.__aiSession?.lastJSON || window.currentEditableItems)) {
      // è·å–å½“å‰çš„é£Ÿç‰©æ•°æ®ï¼ˆä¼˜å…ˆä½¿ç”¨ç”¨æˆ·ç¼–è¾‘è¿‡çš„æ•°æ®ï¼‰
      const currentData = window.currentEditableItems && window.currentEditableItems.length > 0 
        ? window.currentEditableItems 
        : (window.__aiSession?.lastJSON?.items || []);
      
      const currentJSON = {
        items: currentData,
        totals: calcTotals(currentData),
        notes: ''
      };

      console.log('åŸºäºå½“å‰æ•°æ®è¿›è¡Œä¿®æ­£:', currentJSON);
      
      const text = `å½“å‰é£Ÿç‰©æ¸…å•JSONï¼š\n${JSON.stringify(currentJSON)}\n\nç”¨æˆ·ä¿®æ­£æŒ‡ä»¤ï¼š${fixText}\n\nè¯·æ ¹æ®ç”¨æˆ·æŒ‡ä»¤ä¿®æ”¹é£Ÿç‰©æ¸…å•ï¼Œæ¯”å¦‚åˆ é™¤ä¸è¦çš„é£Ÿç‰©ã€ä¿®æ”¹ä»½é‡ç­‰ï¼Œè¿”å›ä¿®æ­£åçš„ä¸¥æ ¼JSONã€‚`;
      json = await callAI({ text, image:null, mode:'revise', prevJSON: currentJSON });

      window.__aiSession = {
        ...(window.__aiSession||{}),
        lastJSON: json,
        messages: [
          ...((window.__aiSession?.messages)||[]),
          { role:'user', text: fixText, ts: Date.now() },
          { role:'assistant', payload: json, ts: Date.now() },
        ]
      };
    } else {
      // é¦–è½®ï¼šæœ‰å›¾ä¼˜å…ˆçœ‹å›¾ï¼›å¦åˆ™çœ‹çº¯æ–‡å­—
      if (hasImage) {
        // å¯æŠŠä¿®æ­£å£ä»¤æ‹¼è¿›æ–‡å­—ï¼Œè®©åç«¯ä¸€å¹¶å‚è€ƒ
        const text = fixText ? `ä¿®æ­£æŒ‡ä»¤ï¼š${fixText}` : (baseText || null);
        json = await callAI({ text, image: selectedImageData, mode:'image' });
        window.__aiSession = { lastJSON: json, img: selectedImageData, messages: [{ role:'assistant', payload: json, ts: Date.now() }] };
      } else {
        const text = baseText || (fixText ? `ä¿®æ­£æŒ‡ä»¤ï¼š${fixText}` : '');
        json = await callAI({ text, image: null, mode:'text' });
        window.__aiSession = { lastJSON: json, img: null, messages: [{ role:'assistant', payload: json, ts: Date.now() }] };
      }

      // å¦‚æœé¦–è½®åè¿˜æœ‰ä¿®æ­£å£ä»¤ï¼Œå†èµ°ä¸€é"ä¿®æ­£"
      if (!hasImage && fixText) {
        const revised = await callAI({
          text: `å½“å‰é£Ÿç‰©æ¸…å•JSONï¼š\n${JSON.stringify(json)}\n\nç”¨æˆ·ä¿®æ­£æŒ‡ä»¤ï¼š${fixText}\n\nè¯·æ ¹æ®ç”¨æˆ·æŒ‡ä»¤ä¿®æ”¹é£Ÿç‰©æ¸…å•ï¼Œè¿”å›ä¿®æ­£åçš„ä¸¥æ ¼JSONã€‚`,
          image: null, mode:'revise', prevJSON: json
        });
        json = revised;
        window.__aiSession = {
          ...(window.__aiSession||{}),
          lastJSON: revised,
          messages: [
            ...((window.__aiSession?.messages)||[]),
            { role:'user', text: fixText, ts: Date.now() },
            { role:'assistant', payload: revised, ts: Date.now() }
          ]
        };
      }
    }

    const show = window.__aiSession?.lastJSON;
    if (!show || !Array.isArray(show.items) || show.items.length===0){
      table.innerHTML = `<div class="text-sm text-neutral-500">æ²¡æœ‰è¯†åˆ«åˆ°æœ‰æ•ˆé£Ÿç‰©ï¼š<br/>Â· çº¯æ–‡å­—å°½é‡ã€Œé£Ÿç‰© + åšæ³• + ä»½é‡ã€<br/>Â· ç…§ç‰‡è¯·ä¿¯æ‹ã€å…‰çº¿å……è¶³ï¼Œå†è¯•ä¸€æ¬¡</div>`;
      document.getElementById('ai-total').textContent = '0kcal';
      return;
    }

    // æ¸²æŸ“ä¸¥æ ¼ JSONï¼ˆä¿ç•™çš„é‚£ä¸€ç‰ˆï¼‰
    renderAiResult(show);
    
    // æ¸…ç©ºä¿®æ­£æŒ‡ä»¤è¾“å…¥æ¡†
    const correctionInput = document.getElementById('ai-correction');
    if (correctionInput) correctionInput.value = '';
    
  }catch(err){
    table.innerHTML = `<div class="text-sm text-red-500">AI è°ƒç”¨å¤±è´¥ï¼š${err?.message || 'è¯·ç¨åå†è¯•'}</div>`;
    showToast('AI è°ƒç”¨å¤±è´¥ï¼š' + (err?.message || 'è¯·ç¨åå†è¯•'));
    console.error('[AI è°ƒç”¨å¤±è´¥]', err);
  }
}


      // ç¡®è®¤AI -> ä¿å­˜åˆ°æœ¬åœ°
document.getElementById('confirm-ai').onclick = () => {
  // 1) ä¼˜å…ˆä½¿ç”¨ç”¨æˆ·ä¿®æ­£åçš„æ•°æ®
  let fin = [];
  let totals = {kcal:0,protein:0,carbs:0,fat:0};

  if (window.currentEditableItems && window.currentEditableItems.length > 0) {
    // ä½¿ç”¨ç”¨æˆ·ä¿®æ­£åçš„æ•°æ®
    fin = window.currentEditableItems.map(it=>({
      name: String(it.name||'é£Ÿç‰©'),
      protein: +(it.protein||0),
      carbs: +(it.carbs||0),
      fat: +(it.fat||0),
      kcal: Math.max(0, Math.round(+it.kcal||0))
    }));
    totals = calcTotals(fin);
  } else {
    // 2) å…œåº•ï¼šä½¿ç”¨ä¼šè¯æ€æ•°æ®
    const j = (window.__aiSession && window.__aiSession.lastJSON) || null;
    
    if (j && Array.isArray(j.items) && j.items.length>0) {
      fin = j.items.map(it=>({
        name: String(it.name||'é£Ÿç‰©'),
        protein: +(it.protein||0),
        carbs: +(it.carbs||0),
        fat: +(it.fat||0),
        kcal: Math.max(0, Math.round(+it.kcal||0))
      }));
      totals = {
        kcal: Math.max(0, Math.round(+j.totals?.kcal||0)),
        protein: +(+j.totals?.protein||0).toFixed(1),
        carbs: +(+j.totals?.carbs||0).toFixed(1),
        fat: +(+j.totals?.fat||0).toFixed(1),
      };
    }
  }

  if (fin.length === 0) {
    showToast('æ²¡æœ‰å¯ä¿å­˜çš„æ¡ç›®');
    return;
  }

  const meals = store.get('meals', []);
  if (editingOldMealKey) {
    const idx = meals.findIndex(x => x.time === editingOldMealKey);
    if (idx > -1) {
      meals[idx].items = fin;
meals[idx].text = formatMealText(fin);   // ç”¨ "é£Ÿç‰© x æ•°é‡" ç®€è¿°æ–‡æ¡ˆ
meals[idx].totals = totals;
      meals[idx].updatedAt = Date.now();
      store.set('meals', meals);
      loadGoalsForToday();
      syncGoalLabels();
      paintMeals();
      // åˆ·æ–°å†å²é¡µå½“æ—¥è¯¦æƒ… & å…³é—­å†å²å¼¹å±‚ï¼Œç»™å‡ºåé¦ˆ
      try { renderDailyDetails(selectedDate); } catch{}
      const hm = document.getElementById('hist-meal-modal');
      if (hm) hm.classList.add('hidden');
      showToast('å·²æ›¿æ¢è¯¥é¤');
    }
    editingOldMealKey = null;
    tempAiItemsForEdit = null;
  } else {
    // åŸæ¥æ˜¯ä» textarea å– textï¼Œè¿™é‡Œæ”¹æˆä½¿ç”¨ formatMealText ç”Ÿæˆçš„ç®€è¿°
const entry = {
  time: Date.now(),
  mealType: currentMeal,
  text: formatMealText(fin),   // å…³é”®ï¼šä¿å­˜ä¸º "ç‰›è‚‰é¢ x 1, é¦™è•‰ x 1"
  items: fin,
  totals
};
    meals.push(entry);
    document.getElementById('meal-text').value = '';
    store.set('meals', meals);
    paintMeals();
    updateStats();
    showToast('å·²æ·»åŠ åˆ°ä»Šå¤©');
  }

  // æœ€åå†å…³é—­å¼¹å±‚å¹¶æ¸…ç†ä¼šè¯
  closeAiModal();
};
 




      // æ¸²æŸ“ä»Šæ—¥åˆ—è¡¨
      // æ¸²æŸ“ä»Šæ—¥åˆ—è¡¨
      function paintMeals(){
  const list = document.getElementById('meals-list');
  const all = store.get('meals', []);

  const todayKey = ymdKey(new Date());
  const meals = all.filter(m => ymdKey(new Date(m.time)) === todayKey);

  list.innerHTML = '';
  if(meals.length===0){
    document.getElementById('empty-state-today').classList.remove('hidden');
    return;
  }
  document.getElementById('empty-state-today').classList.add('hidden');

  // é¤æ¬¡ä¸­æ–‡åæ˜ å°„
  const MEAL_NAME = {
    breakfast: 'æ—©é¤',
    lunch: 'åˆé¤',
    dinner: 'æ™šé¤',
    night: 'å¤œå®µ',
    snack: 'åŠ é¤'
  };

  meals.slice().reverse().forEach((m)=>{
    const when = new Date(m.time).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
    const mealName = MEAL_NAME[m.mealType] || 'â€”';

    const card = document.createElement('div');
    card.className = 'bg-white dark:bg-neutral-800 rounded-xl shadow-light p-5 border border-neutral-200 dark:border-neutral-700 transition-transform-shadow';

    // è¿™é‡ŒæŠŠã€Œé¤æ¬¡åã€åšæˆå°åœ†è§’æ ‡ç­¾æ”¾åœ¨æ—¶é—´æ—è¾¹
    card.innerHTML = `
      <div class='flex justify-between items-start'>
        <div>
          <div class='flex items-center gap-2 mb-1'>
            <span class='px-2 py-0.5 rounded-full bg-neutral-100 dark:bg-neutral-700 text-xs'>${mealName}</span>
            <span class='font-medium text-sm'>${when}</span>
          </div>
          <div class='text-xs text-neutral-500 dark:text-neutral-400'>${m.text}</div>
        </div>
        <button class='touch-target p-2 text-neutral-400 hover:text-red-500' data-del='1'>
          <i class='fa-solid fa-trash-alt'></i>
        </button>
      </div>
      <div class='mt-2 text-xs text-neutral-500 dark:text-neutral-400 space-x-2 flex flex-wrap'>
        <span>${m.totals.kcal}kcal</span>
        <span>è›‹ç™½è´¨${m.totals.protein}</span>
        <span>ç¢³æ°´${m.totals.carbs}</span>
        <span>è„‚è‚ª${m.totals.fat}</span>
      </div>`;

    card.querySelector('[data-del]')?.addEventListener('click',()=>{
      const all = store.get('meals', []);
      const idx = all.findIndex(x=>x.time===m.time);
      if(idx>-1){ all.splice(idx,1); store.set('meals', all); paintMeals(); updateStats(); showToast('å·²åˆ é™¤æœ¬é¤'); }
    });

    list.appendChild(card);
  });
}

      // ç»Ÿè®¡æ±‡æ€»
      function updateStats(){
  const all = store.get('meals', []);
  const todayKey = ymdKey(new Date());
  const meals = all.filter(m => ymdKey(new Date(m.time)) === todayKey);

  const totals = meals.reduce((a,m)=>({
    kcal:   a.kcal   + (m.totals?.kcal   || 0),
    protein:a.protein+ (m.totals?.protein|| 0),
    carbs:  a.carbs  + (m.totals?.carbs  || 0),
    fat:    a.fat    + (m.totals?.fat    || 0)
  }), {kcal:0,protein:0,carbs:0,fat:0});

  const goalCal = +document.getElementById('goal-cal').value || 2000;
  const goalPro = +document.getElementById('goal-pro').value || 100;
  const goalFat = +document.getElementById('goal-fat').value || 65;
  let goalCarbs = getTargetCarbs(goalCal, goalPro, goalFat);
  const goalCarbsEl = document.getElementById('goal-carbs-label');
  if (goalCarbsEl) goalCarbsEl.textContent = goalCarbs;

  // è®¡ç®—å‰©ä½™ä¸è¶…å‡º
  const remainCal = Math.max(0, goalCal - totals.kcal);
  const remainPro = Math.max(0, goalPro - totals.protein);
  const remainCar = Math.max(0, goalCarbs - totals.carbs);
  const remainFat = Math.max(0, goalFat - totals.fat);
  const overCal = Math.max(0, totals.kcal - goalCal);
  const overPro = Math.max(0, totals.protein - goalPro);
  const overCar = Math.max(0, totals.carbs - goalCarbs);
  const overFat = Math.max(0, totals.fat - goalFat);

  // çƒ­é‡è¿›åº¦ + æ–‡æ¡ˆ"å·²/ç›®/å‰©"
  const calPct = goalCal ? Math.min(100, Math.round((totals.kcal/goalCal)*100)) : 0;
  const calText = totals.kcal <= goalCal
    ? `${totals.kcal} / ${goalCal} kcalï¼ˆå‰©ä½™ ${remainCal}ï¼‰`
    : `${totals.kcal} / ${goalCal} kcalï¼ˆè¶… ${overCal}ï¼‰`;
  document.getElementById('calories-progress').textContent = calText;
  document.getElementById('calories-bar').style.width = calPct + '%';

  // æ•°å­—æ˜¾ç¤º
  document.getElementById('stat-protein').textContent = (totals.protein <= goalPro)
    ? `${(totals.protein||0).toFixed(1)} gï¼ˆå‰© ${remainPro.toFixed(1)}ï¼‰`
    : `${(totals.protein||0).toFixed(1)} gï¼ˆè¶… ${overPro.toFixed(1)}ï¼‰`;
  document.getElementById('stat-carbs').textContent   = (totals.carbs <= goalCarbs)
    ? `${(totals.carbs||0).toFixed(1)} gï¼ˆå‰© ${remainCar.toFixed(1)}ï¼‰`
    : `${(totals.carbs||0).toFixed(1)} gï¼ˆè¶… ${overCar.toFixed(1)}ï¼‰`;
  document.getElementById('stat-fat').textContent     = (totals.fat <= goalFat)
    ? `${(totals.fat||0).toFixed(1)} gï¼ˆå‰© ${remainFat.toFixed(1)}ï¼‰`
    : `${(totals.fat||0).toFixed(1)} gï¼ˆè¶… ${overFat.toFixed(1)}ï¼‰`;

  // è¿›åº¦æ¡
  const proPct  = goalPro   ? Math.min(100, Math.round((totals.protein/goalPro)*100)) : 0;
  const carbPct = goalCarbs ? Math.min(100, Math.round((totals.carbs/goalCarbs)*100)) : 0;
  const fatPct  = goalFat   ? Math.min(100, Math.round((totals.fat/goalFat)*100))     : 0;
  const proBar  = document.getElementById('protein-bar');
  const carbBar = document.getElementById('carbs-bar');
  const fatBar  = document.getElementById('fat-bar');
  if (proBar)  proBar.style.width  = proPct  + '%';
  if (carbBar) carbBar.style.width = carbPct + '%';
  if (fatBar)  fatBar.style.width  = fatPct  + '%';
}
loadGoalsForToday();
syncGoalLabels();
paintMeals();

      // ============== å†å²é¡µï¼ˆå‘¨/æœˆè§†å›¾ + æ—¥å† + å½“å¤©è¯¦æƒ… + ç¼–è¾‘ï¼‰ ==============

// å°å·¥å…·
const MEAL_I18N = { breakfast:'æ—©é¤', lunch:'åˆé¤', dinner:'æ™šé¤', night:'å¤œå®µ', snack:'åŠ é¤' };
const MEAL_ORDER = ['breakfast','lunch','dinner','snack','night'];

const two = (n) => (window.SharedDate && SharedDate.twoDigits) ? SharedDate.twoDigits(n) : (n < 10 ? '0'+n : ''+n);
const ymd = (d) => (window.SharedDate && SharedDate.formatYMD) ? SharedDate.formatYMD(d) : `${d.getFullYear()}-${two(d.getMonth()+1)}-${two(d.getDate())}`;
const addDays = (d, n) => (window.SharedDate && SharedDate.addDays) ? SharedDate.addDays(d, n) : (function(){ const x=new Date(d); x.setDate(x.getDate()+n); return x; })();
const startOfWeek = (d) => (window.SharedDate && SharedDate.startOfWeek) ? SharedDate.startOfWeek(d) : (function(){ const x = new Date(d.getFullYear(), d.getMonth(), d.getDate()); const wd = (x.getDay()+6)%7; x.setDate(x.getDate()-wd); return x; })();
const startOfMonth = (d) => (window.SharedDate && SharedDate.startOfMonth) ? SharedDate.startOfMonth(d) : new Date(d.getFullYear(), d.getMonth(), 1);
const endOfMonth = (d) => (window.SharedDate && SharedDate.endOfMonth) ? SharedDate.endOfMonth(d) : new Date(d.getFullYear(), d.getMonth()+1, 0);

const getMeals = () => store.get('meals', []);
const mealsOfDate = (date) => {
  const key = ymd(date);
  return getMeals().filter(m => ymd(new Date(m.time)) === key);
};
const totalsOfDate = (date) => {
  const arr = mealsOfDate(date);
  return arr.reduce((a,m)=>({
    kcal:a.kcal+(m.totals?.kcal||0),
    protein:a.protein+(m.totals?.protein||0),
    carbs:a.carbs+(m.totals?.carbs||0),
    fat:a.fat+(m.totals?.fat||0),
  }), {kcal:0,protein:0,carbs:0,fat:0});
};

// å†å²é¡µçŠ¶æ€
let historyView = 'week';                   // 'week' | 'month'
let periodStart = startOfWeek(new Date());  // å‘¨è§†å›¾ï¼šæ‰€åœ¨å‘¨å‘¨ä¸€ï¼›æœˆè§†å›¾ï¼šæ‰€åœ¨æœˆ 1 å·
let selectedDate = new Date();              // å½“å‰é€‰ä¸­çš„å…·ä½“å“ªä¸€å¤©

function initHistory(){
  // è¿›å…¥å†å²é¡µæ—¶ï¼Œåˆ·æ–°çŠ¶æ€ï¼ˆä¿è¯"ä¸‹ä¸€æœŸ"ä¸ä¼šè¶Šè¿‡ä»Šå¤©ï¼‰
  const weekActive  = document.getElementById('btn-week')?.classList.contains('bg-white');
const monthActive = document.getElementById('btn-month')?.classList.contains('bg-white');
if (weekActive)  historyView = 'week';
if (monthActive) historyView = 'month';
  periodStart = historyView === 'week' ? startOfWeek(selectedDate) : startOfMonth(selectedDate);
// ========= å†å²é¤è¯¦æƒ…å¼¹å±‚ =========
const hmModal  = document.getElementById('hist-meal-modal');
const hmClose  = document.getElementById('hm-close');
const hmItems  = document.getElementById('hm-items');
let   hmEditingKey = null;

function openHistMealModal(mealKey){
  const all = store.get('meals', []);
  const m = all.find(x=>x.time===mealKey);
  if(!m) return;
  hmEditingKey = mealKey;

  const titleMap = {breakfast:'æ—©é¤', lunch:'åˆé¤', dinner:'æ™šé¤', night:'å¤œå®µ', snack:'åŠ é¤'};
  const hTitle = document.getElementById('hm-title'); if(hTitle) hTitle.textContent = (titleMap[m.mealType]||'é¤') + 'è¯¦æƒ…';
  const d = new Date(m.time);
  const two = (n)=> (window.SharedDate && SharedDate.twoDigits) ? SharedDate.twoDigits(n) : (n<10?'0'+n:''+n);
  const hDate = document.getElementById('hm-date'); if(hDate) hDate.textContent = `${d.getFullYear()}-${two(d.getMonth()+1)}-${two(d.getDate())}`;
  const hNote = document.getElementById('hm-note'); if(hNote) hNote.value = m.note || '';

  // æ¸²æŸ“æ¯ä¸ªé£Ÿç‰©æ¡ç›®ä¸ºåªè¯»è¡Œ
hmItems.innerHTML = '';
(m.items || []).forEach((it) => {
  const row = document.createElement('div');
  row.className = 'p-3 rounded-xl bg-neutral-50 dark:bg-neutral-700';
  row.innerHTML = `
    <div class="flex justify-between items-center">
      <div class="font-medium">${it.name || 'é£Ÿç‰©'}</div>
      <div class="text-sm text-neutral-500">${it.kcal || 0}kcal</div>
    </div>
    <div class="grid grid-cols-3 gap-2 mt-2 text-xs text-neutral-500 dark:text-neutral-400">
      <div>è›‹ç™½ ${it.protein || 0}g</div>
      <div>ç¢³æ°´ ${it.carbs   || 0}g</div>
      <div>è„‚è‚ª ${it.fat     || 0}g</div>
    </div>
  `;
  hmItems.appendChild(row);
});

// ä¿®æ”¹ä¿å­˜æŒ‰é’®æ–‡æ¡ˆ
const hSaveBtn = document.getElementById('hm-save'); if(hSaveBtn){ hSaveBtn.textContent = 'è®© AI ç”Ÿæˆæ–°çš„ä¸€é¤'; }
  // åŒæ­¥æœ¬é¤åˆè®¡
  const totals = m.totals && isFinite(+m.totals.kcal) ? m.totals : calcTotals(m.items||[]);
  const elK = document.getElementById('hm-total-kcal'); if (elK) elK.textContent = `${Math.max(0, Math.round(+totals.kcal||0))}kcal`;
  const elP = document.getElementById('hm-total-pro');  if (elP) elP.textContent = (+totals.protein||0).toFixed(1);
  const elC = document.getElementById('hm-total-carb'); if (elC) elC.textContent = (+totals.carbs||0).toFixed(1);
  const elF = document.getElementById('hm-total-fat');  if (elF) elF.textContent = (+totals.fat||0).toFixed(1);
  hmModal.classList.remove('hidden');
  hmModal.classList.add('flex');
}
window.openHistMealModal = openHistMealModal;

function recalcModalTotals(){
  const all = store.get('meals', []);
  const m = all.find(x=>x.time===hmEditingKey);
  if(!m) return;

  let sum = {k:0,p:0,c:0,f:0};
  (m.items||[]).forEach((it, idx)=>{
    const p = +document.querySelector(`[data-edit="${idx}-p"]`)?.value || 0;
    const c = +document.querySelector(`[data-edit="${idx}-c"]`)?.value || 0;
    const f = +document.querySelector(`[data-edit="${idx}-f"]`)?.value || 0;
    const kcal = Math.round(p*4 + c*4 + f*9);
    const kcalSpan = document.querySelector(`[data-k="${idx}-kcal"]`);
    if(kcalSpan) kcalSpan.textContent = kcal;
    sum.k += kcal; sum.p += p; sum.c += c; sum.f += f;
  });
  document.getElementById('hm-total-kcal').textContent = `${sum.k}kcal`;
  document.getElementById('hm-total-pro').textContent  = sum.p.toFixed(1);
  document.getElementById('hm-total-carb').textContent = sum.c.toFixed(1);
  document.getElementById('hm-total-fat').textContent  = sum.f.toFixed(1);
}

if(hmClose) hmClose.onclick = ()=> hmModal.classList.add('hidden');

const __saveBtn = document.getElementById('hm-save');
if (__saveBtn) __saveBtn.onclick = async () => {
  const loading = document.getElementById('hm-loading');
  if (loading) loading.classList.remove('hidden');
  const all = store.get('meals', []);
  const m = all.find(x => x.time === hmEditingKey);
  if (!m) return;

  // ç»„åˆç»™AIçš„è¾“å…¥ï¼šåŸå§‹æ–‡æœ¬ + ä¿®æ­£è¯´æ˜
  const note = ((document.getElementById('hm-note')||{}).value || '').trim();
  const aiInput = (m.text || '') + (note ? ('ï¼›ä¿®æ­£è¯´æ˜ï¼š' + note) : '');

  let ret;
  try {
    ret = await callAI({ text: aiInput, image: null, mode:'text' });
  } catch (e) {
    showToast('AI ç”Ÿæˆå¤±è´¥ï¼š' + (e?.message || 'è¯·ç¨åé‡è¯•'));
    if (loading) loading.classList.add('hidden');
    return;
  }

  const items = Array.isArray(ret?.items) ? ret.items : [];
  if (items.length === 0) {
    showToast('AI æœªç”Ÿæˆæœ‰æ•ˆæ¡ç›®ï¼Œè¯·è°ƒæ•´ä¿®æ­£è¯´æ˜å†è¯•ã€‚');
    if (loading) loading.classList.add('hidden');
    return;
  }

  // æŠŠAIç»“æœé¢„æ¸²æŸ“åˆ° ai-modal çš„è¡¨æ ¼ï¼ˆå¯ç»§ç»­æ‹–åŠ¨æ»‘æ†å¾®è°ƒï¼‰
  const json = { items, totals: calcTotals(items), notes: ret?.notes || '' };
renderAiResult(json);
  tempAiItemsForEdit = items;
  editingOldMealKey = hmEditingKey;

  // æ‰“å¼€ ai-modal è®©ä½ ç¡®è®¤
  document.getElementById('ai-modal').classList.remove('hidden');
  showToast('å·²ç”Ÿæˆæ–°çš„ä¸€é¤ï¼Œè¯·ç¡®è®¤åº”ç”¨');
  if (loading) loading.classList.add('hidden');
};

const hDelBtn = document.getElementById('hm-delete');
if (hDelBtn) hDelBtn.onclick = ()=>{
  const all = store.get('meals', []);
  const idx = all.findIndex(x=>x.time===hmEditingKey);
  if(idx<0) return;
  all.splice(idx,1);
  store.set('meals', all);
  paintMeals();
  updateStats();
  renderDailyDetails(selectedDate);
  hmModal.classList.add('hidden');
};
  // ç»‘å®šè§†å›¾åˆ‡æ¢
  document.querySelectorAll('[data-view]').forEach(btn=>{
    btn.onclick = () => {
      document.querySelectorAll('[data-view]').forEach(b=>b.classList.remove('bg-white','dark:bg-neutral-700','shadow-sm'));
      btn.classList.add('bg-white','dark:bg-neutral-700','shadow-sm');
      historyView = btn.getAttribute('data-view');
      periodStart = historyView==='week' ? startOfWeek(selectedDate) : startOfMonth(selectedDate);
      renderPeriodHeader();
      renderCalendar();
      initChart(window.__chartState?.metric || 'calories', historyView, periodStart, selectedDate);
    };
  });

  // ä¸Š/ä¸‹ä¸€æœŸ
  document.getElementById('prev-period').onclick = () => {
    periodStart = historyView==='week' ? addDays(periodStart,-7) : new Date(periodStart.getFullYear(), periodStart.getMonth()-1, 1);
    // åˆ‡æ¢æœŸæ—¶é»˜è®¤é€‰ä¸­è¯¥å‘¨æœŸç¬¬ä¸€å¤©
    selectedDate = periodStart;
    renderPeriodHeader(); renderCalendar(); renderDailyDetails(selectedDate);
    initChart(window.__chartState?.metric || 'calories', historyView, periodStart, selectedDate);
  };
  document.getElementById('next-period').onclick = () => {
  const today = new Date();
  const next = historyView==='week' ? addDays(periodStart,7) : new Date(periodStart.getFullYear(), periodStart.getMonth()+1, 1);

  const limit = historyView==='week' ? startOfWeek(today) : startOfMonth(today);
  if (next > limit) return;
  periodStart = next;
  selectedDate = periodStart;
  renderPeriodHeader();
  renderCalendar();
  renderDailyDetails(selectedDate);
  initChart(window.__chartState?.metric || 'calories', historyView, periodStart, selectedDate); 
};

  // åˆæ¬¡æ¸²æŸ“
  renderPeriodHeader();
  renderCalendar();
  renderDailyDetails(selectedDate);
  // æŒ‰éœ€åŠ è½½ ECharts åå†åˆå§‹åŒ–å›¾è¡¨
  (async ()=>{
    if(!window.echarts){
      await new Promise((resolve)=>{
        const s=document.createElement('script');
        s.src='https://cdn.bootcdn.net/ajax/libs/echarts/5.4.3/echarts.min.js';
        s.onload=resolve; document.head.appendChild(s);
      });
    }
    initChart('calories', historyView, periodStart, selectedDate);
  })();
}

// é¡¶éƒ¨ä¸­é—´çš„æ—¥æœŸèŒƒå›´/æœˆä»½
function renderPeriodHeader(){
  const el = document.getElementById('current-period');
  if(historyView==='week'){
    const start = periodStart;
    const end = addDays(start,6);
    el.textContent = `${start.getMonth()+1}æœˆ${start.getDate()}æ—¥ - ${end.getMonth()+1}æœˆ${end.getDate()}æ—¥`;
  }else{
    el.textContent = `${periodStart.getFullYear()}å¹´ ${periodStart.getMonth()+1}æœˆ`;
  }

  // "ä¸‹ä¸€æœŸ"æ˜¯å¦ç¦ç”¨
  const nextBtn = document.getElementById('next-period');
  const today = new Date();
  const limit = historyView==='week' ? startOfWeek(today) : startOfMonth(today);
  const willNext = historyView==='week' ? addDays(periodStart,7) : new Date(periodStart.getFullYear(), periodStart.getMonth()+1, 1);
  if (willNext > limit){ nextBtn.disabled = true; nextBtn.classList.add('opacity-50'); }
  else { nextBtn.disabled = false; nextBtn.classList.remove('opacity-50'); }
}

// æ¸²æŸ“å‘¨ / æœˆæ—¥å†
function renderCalendar(){
  const box = document.getElementById('calendar-wrap');
  const todayKey = ymd(new Date());
  let html = '';

  const dayCell = (date) => {
  const key = ymd(date);
  const t = totalsOfDate(date);
  const isSel = key === ymd(selectedDate);
  const isToday = key === todayKey;
  return `
    <button class="w-full p-3 rounded-xl border ${isSel ? 'border-primary bg-primary/5' : 'border-transparent hover:bg-neutral-50 dark:hover:bg-neutral-700/40'} transition-colors text-center"
            data-pick="${key}">
      <div class="text-base font-medium ${isSel?'text-primary':''}">${date.getDate()}</div>
      <div class="mt-2 text-xs text-neutral-500 dark:text-neutral-400 leading-tight text-center tabular-nums flex flex-col items-center">
        <div>${t.kcal}</div>
        <div>kcal</div>
      </div>
    </button>
  `;
};

  if(historyView==='week'){
    html += '<div class="grid grid-cols-7 gap-2">';
    for(let i=0;i<7;i++){
      html += dayCell(addDays(periodStart,i));
    }
    html += '</div>';
  }else{
    const first = startOfMonth(periodStart);
    const last = endOfMonth(periodStart);
    const start = startOfWeek(first);               // æœˆå‰è¡¥é½åˆ°å‘¨ä¸€
    const cells = [];
    for(let d=0; d<42; d++){                        // 6 è¡Œ * 7 åˆ—
      const cur = addDays(start,d);
      const inMonth = cur.getMonth() === periodStart.getMonth();
      cells.push(`<div class="${inMonth?'':'opacity-40'}">${dayCell(cur)}</div>`);
    }
    html += `
      <div class="grid grid-cols-7 gap-2 mb-2 text-xs text-neutral-500 dark:text-neutral-400">
        <div class="text-center">ä¸€</div><div class="text-center">äºŒ</div><div class="text-center">ä¸‰</div>
        <div class="text-center">å››</div><div class="text-center">äº”</div><div class="text-center">å…­</div><div class="text-center">æ—¥</div>
      </div>
      <div class="grid grid-cols-7 gap-2">${cells.join('')}</div>
    `;
  }

  box.innerHTML = html;

  // é€‰æ—¥
  box.querySelectorAll('[data-pick]').forEach(btn=>{
    btn.onclick = () => {
      selectedDate = new Date(btn.getAttribute('data-pick'));
      renderCalendar();
      renderDailyDetails(selectedDate);
      initChart(window.__chartState?.metric || 'calories', historyView, periodStart, selectedDate);
    };
  });
}

function renderDailyDetails(date){
  const list = document.getElementById('daily-meals');
  const head = document.getElementById('detail-date');
  const target = document.getElementById('daily-target');
  const summary = document.getElementById('daily-summary');

  const two = (n)=> (window.SharedDate && SharedDate.twoDigits) ? SharedDate.twoDigits(n) : (n<10?'0'+n:''+n);
  const ymd = (d)=> (window.SharedDate && SharedDate.formatYMD) ? SharedDate.formatYMD(d) : `${d.getFullYear()}-${two(d.getMonth()+1)}-${two(d.getDate())}`;

  head.textContent = ymd(date);

  // ç›®æ ‡ï¼ˆç”¨"ä»Šæ—¥æ ‡å‡†"è¾“å…¥æ¨ç®—ï¼‰
  const goalCal = +document.getElementById('goal-cal').value || 2000;
  const goalPro = +document.getElementById('goal-pro').value || 100;
  const goalFat = +document.getElementById('goal-fat').value || 65;
  let goalCarbs = (window.SharedNutrition && SharedNutrition.getTargetCarbs) ? SharedNutrition.getTargetCarbs(goalCal, goalPro, goalFat) : (function(){ let v = Math.round((goalCal - goalPro*4 - goalFat*9) / 4); if (!isFinite(v) || v < 0) v = 0; return v; })();
  target.textContent = `å½“æ—¥ç›®æ ‡ï¼š${goalCal}kcalï½œè›‹ç™½${goalPro}gï½œç¢³æ°´${goalCarbs}gï½œè„‚è‚ª${goalFat}g`;

  // åˆ—è¡¨
  const meals = mealsOfDate(date).sort((a,b)=>a.time-b.time);
  list.innerHTML = meals.map((m, idx) => {
    const t = m.totals || {kcal:0,protein:0,carbs:0,fat:0};
    const timeText = new Date(m.time).toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'});
    const rowClass = idx === meals.length - 1
      ? `w-full text-left pb-4`
      : `w-full text-left border-b border-neutral-100 dark:border-neutral-700 pb-4`;
    return `
      <button class="${rowClass}" data-open="${m.time}">
        <div class="flex justify-between items-start mb-1">
          <div class="font-medium text-sm">${MEAL_I18N[m.mealType] || 'â€”'} <span class="ml-2 text-xs text-neutral-500">${timeText}</span></div>
          <div class="text-sm">${t.kcal}kcal</div>
        </div>
        <div class="text-sm text-neutral-700 dark:text-neutral-300 mb-1">${m.text}</div>
        <div class="text-xs text-neutral-500 dark:text-neutral-400">è›‹ç™½è´¨ ${t.protein}g Â· ç¢³æ°´ ${t.carbs}g Â· è„‚è‚ª ${t.fat}g</div>
      </button>
    `;
  }).join('');

  // æ€»ç»“
  const total = totalsOfDate(date);
  summary.classList.toggle('hidden', meals.length===0);
  summary.innerHTML = meals.length===0 ? '' : `
    <div class="flex justify-between items-center text-sm font-medium mb-2"><div>å½“æ—¥æ€»è®¡</div><div>${total.kcal}kcal</div></div>
    <div class="grid grid-cols-3 gap-2 text-center text-xs text-neutral-500 dark:text-neutral-400">
      <div>è›‹ç™½è´¨ ${total.protein.toFixed(1)}g</div>
      <div>ç¢³æ°´ ${total.carbs.toFixed(1)}g</div>
      <div>è„‚è‚ª ${total.fat.toFixed(1)}g</div>
    </div>
  `;

  // ç‚¹å‡»ä»»æ„ä¸€é¤ -> æ‰“å¼€å¼¹å±‚ï¼ˆäº‹ä»¶å§”æ‰˜ï¼Œé¿å…é‡å¤ç»‘å®šï¼‰
  list.onclick = (ev)=>{
    const target = ev.target.closest('[data-open]');
    if(!target) return;
    const key = +target.getAttribute('data-open');
    openHistMealModal(key);
  };
  // ä¿é™©ï¼šå…¨å±€æ•è·ä»£ç†ä¸€æ¬¡ï¼Œé¿å…ä¸ªåˆ«è®¾å¤‡/ç»„ä»¶é˜»æ–­å†’æ³¡
  if (!window.__dailyOpenBound) {
    document.addEventListener('click', (e)=>{
      const el = e.target && e.target.closest && e.target.closest('[data-open]');
      if(!el) return;
      const key = +el.getAttribute('data-open');
      if (!isNaN(key)) {
        e.preventDefault();
        openHistMealModal(key);
      }
    }, true);
    window.__dailyOpenBound = true;
  }
}

// å‘¨/æœˆå›¾è¡¨ï¼šå‘¨=7æ ¹ï¼›æœˆ=å½“æœˆ1å·åˆ°æœˆæœ«çš„å¤©æ•°æ ¹ï¼›é€‰ä¸­æ—¥æ”¾ç¬¬ä¸€æ ¹å¹¶é«˜äº®
function initChart(metric = 'calories', view = historyView, start = periodStart, picked = selectedDate) {
  // å…œåº•ï¼šè‹¥ echarts è¿˜æœªåŠ è½½åˆ™æŒ‰éœ€åŠ è½½ï¼ŒåŠ è½½åå†é‡å…¥
  if (typeof window.echarts === 'undefined') {
    if (!window.__loadingEcharts) {
      window.__loadingEcharts = true;
      const s = document.createElement('script');
      s.src = 'https://cdn.bootcdn.net/ajax/libs/echarts/5.4.3/echarts.min.js';
      s.onload = function(){ window.__loadingEcharts = false; try{ initChart(metric, view, start, picked); }catch(e){} };
      document.head.appendChild(s);
    }
    return;
  }
  const chartDom = document.getElementById('metrics-chart');
  const existing = echarts.getInstanceByDom(chartDom);
if (existing) existing.dispose();
const myChart = echarts.init(chartDom);
  const isDark = document.documentElement.classList.contains('dark');
  const textColor = isDark ? '#F9FAFB' : '#1F2937';
  const axisLineColor = isDark ? '#4B5563' : '#E5E7EB';
  const splitLineColor = isDark ? '#374151' : '#F3F4F6';
  let barColor = '#EF4444';
  if (metric === 'protein') barColor = '#FF7A00';
  if (metric === 'carbs')   barColor = '#00B4D8';
  if (metric === 'fat')     barColor = '#8B5CF6';

  // ç»„è£…æ—¥æœŸåºåˆ—
  const days = [];
  if (view === 'week') {
    for (let i = 0; i < 7; i++) days.push(addDays(start, i));
  } else {
    const first = startOfMonth(start);
    const last  = endOfMonth(start);
    for (let d = new Date(first); d <= last; d = addDays(d, 1)) days.push(new Date(d));
  }

  // å…ˆæŒ‰è‡ªç„¶é¡ºåºç®—å€¼
  const raw = days.map(d => {
    const t = totalsOfDate(d);
    if (metric === 'calories') return t.kcal || 0;
    if (metric === 'protein')  return +(t.protein || 0).toFixed(1);
    if (metric === 'carbs')    return +(t.carbs   || 0).toFixed(1);
    if (metric === 'fat')      return +(t.fat     || 0).toFixed(1);
    return 0;
  });

  // ä¿æŒæ—¶é—´é¡ºåºï¼Œä»…é«˜äº®é€‰ä¸­æ—¥æœŸ
  const pickKey = ymd(picked);
  const selectedIdx = days.findIndex(d => ymd(d) === pickKey);
  const labels = days.map(d => (view === 'week') ? `${d.getMonth()+1}/${d.getDate()}` : (d.getDate() + 'æ—¥'));
  const vals   = raw;

  // æœˆè§†å›¾åš"ç»†ç«–çº¿"æ•ˆæœï¼šé™åˆ¶æŸ±å®½
  const option = {
    color: [barColor],
    grid: { left: '6%', right: '4%', bottom: '14%', top: 28, containLabel: true },
    tooltip: { trigger: 'axis', axisPointer: { type: 'shadow' } },
    xAxis: {
      type: 'category',
      data: labels,
      axisLine: { lineStyle: { color: axisLineColor } },
      axisLabel: { color: textColor, fontSize: 12 },
      axisTick: { show: false }
    },
    yAxis: {
      type: 'value',
      name: metric === 'calories' ? 'çƒ­é‡ (kcal)' : (metric === 'protein' ? 'è›‹ç™½è´¨ (g)' : metric === 'carbs' ? 'ç¢³æ°´ (g)' : 'è„‚è‚ª (g)'),
      nameTextStyle: { color: textColor, fontSize: 12, padding: [0,0,0,10] },
      axisLine: { show: false },
      axisLabel: { color: textColor, fontSize: 12 },
      splitLine: { lineStyle: { color: splitLineColor } },
      axisTick: { show: false }
    },
    series: [{
      type: 'bar',
      data: vals,
      barWidth: view === 'month' ? undefined : '40%',
      // 30æ ¹ä»¥ä¸Šæ—¶ä½¿ç”¨æ›´ç»†çš„æŸ±ä½“
      barCategoryGap: view === 'month' ? '80%' : '30%',
      barMaxWidth: view === 'month' ? 6 : 28,
      itemStyle: {
        borderRadius: [3, 3, 0, 0],
        // ç¬¬ä¸€æ ¹ï¼ˆè¢«é€‰ä¸­çš„é‚£å¤©ï¼‰é«˜äº®ä¸ºçº¯è‰²ï¼Œå…¶ä½™ä½¿ç”¨é»˜è®¤è‰²
        color: function (params) {
          if (params.dataIndex === selectedIdx) return barColor;
          return echarts.color.lift(barColor, 0.15);
        }
      }
    }]
  };

  myChart.setOption(option);
  window.addEventListener('resize', () => myChart.resize());

  // è®°ä½å½“å‰é…ç½®ï¼Œç»™"åˆ‡æŒ‡æ ‡"æ—¶å¤ç”¨
  window.__chartState = { metric, view, start, picked };
}
// æŒ‡æ ‡æŒ‰é’®
document.querySelectorAll('[data-metric]').forEach(btn=>{
  btn.onclick = () => {
    document.querySelectorAll('[data-metric]').forEach(b=>b.classList.remove('bg-white','dark:bg-neutral-600','shadow-sm'));
    btn.classList.add('bg-white','dark:bg-neutral-600','shadow-sm');
    const metric = btn.getAttribute('data-metric');
    initChart(metric, historyView, periodStart, selectedDate);
  };
});

// åˆå§‹åŒ–ï¼šåŠ è½½ä»Šå¤©ç›®æ ‡ï¼ˆä¾èµ– profile é»˜è®¤ï¼‰
loadGoalsForToday();
loadProfile();
// åˆå§‹è¿›å…¥"ä»Šå¤©"
switchTab('today');

// â€”â€” è·¨æ—¥è‡ªåŠ¨åˆ·æ–°ï¼ˆæ¯æ—¥ 00:00 è§¦å‘ + å›å‰å°æ ¡éªŒï¼‰ â€”â€”
let __lastDateKey = ymdKey(new Date());
function refreshForNewDay(){
  __lastDateKey = ymdKey(new Date());
  // æ›´æ–°ä»Šå¤©é¡µæ—¥æœŸ
  try{ const cd = document.getElementById('current-date'); if(cd) cd.textContent = __lastDateKey; }catch{}
  // é‡æ–°åŠ è½½ä»Šæ—¥ç›®æ ‡ä¸åˆ—è¡¨/è¿›åº¦
  try{ loadGoalsForToday(); }catch{}
  try{ syncGoalLabels(); }catch{}
  try{ paintMeals(); }catch{}
  try{ updateStats(); }catch{}
  // é‡ç½®å†å²é¡µåˆ°æ–°çš„ä¸€å¤©
  try{
    if (typeof renderPeriodHeader === 'function' && typeof renderCalendar === 'function' && typeof renderDailyDetails === 'function') {
      selectedDate = new Date();
      renderPeriodHeader();
      renderCalendar();
      renderDailyDetails(selectedDate);
    }
    if (typeof initChart === 'function') {
      const st = window.__chartState || {}; // ä¿æŒå½“å‰æŒ‡æ ‡
      initChart(st.metric || 'calories', historyView, periodStart, selectedDate);
    }
  }catch{}
}

function scheduleMidnightRefresh(){
  const now = new Date();
  const next = new Date(now.getFullYear(), now.getMonth(), now.getDate() + 1, 0, 0, 0, 50);
  const delay = Math.max(0, next - now);
  setTimeout(()=>{ refreshForNewDay(); scheduleMidnightRefresh(); }, delay);
}
scheduleMidnightRefresh();
// å½“åº”ç”¨å›åˆ°å‰å°æ—¶ï¼Œå¦‚æœå·²ç»è·¨æ—¥åˆ™ç«‹å³åˆ·æ–°
document.addEventListener('visibilitychange', ()=>{
  if (document.visibilityState === 'visible') {
    const todayKey = ymdKey(new Date());
    if (todayKey !== __lastDateKey) refreshForNewDay();
  }
});

// â€”â€” å®¢æœå¼¹çª—é€»è¾‘ï¼ˆä¸ä¾èµ–å…¶ä»–å·¥å…·ï¼‰ â€”â€”
(function initHelpModal(){
  const helpModal = document.getElementById('help-modal');
  const helpBtn = document.getElementById('help-btn');
  const helpClose = document.getElementById('help-close');
  const submitFeedback = document.getElementById('submit-feedback');
  if(!helpModal || !helpBtn || !helpClose || !submitFeedback){
    return; // è‹¥æœªæ‰¾åˆ°ç›¸å…³å…ƒç´ ï¼Œç›´æ¥è·³è¿‡
  }
  helpBtn.addEventListener('click', ()=>{
    helpModal.classList.remove('hidden');
    helpModal.classList.add('flex');
  });
  helpClose.addEventListener('click', ()=>{
    helpModal.classList.add('hidden');
    helpModal.classList.remove('flex');
  });
  helpModal.addEventListener('click', (e)=>{
    if(e.target === helpModal){
      helpModal.classList.add('hidden');
      helpModal.classList.remove('flex');
    }
  });
  submitFeedback.addEventListener('click', ()=>{
    const txt = (document.getElementById('feedback-text')?.value||'').trim();
    if(!txt){ showToast('è¯·è¾“å…¥åé¦ˆå†…å®¹'); return; }
    showToast('æ„Ÿè°¢æ‚¨çš„åé¦ˆï¼');
    const ta = document.getElementById('feedback-text');
    if(ta) ta.value = '';
    helpModal.classList.add('hidden');
    helpModal.classList.remove('flex');
  });
})();
// ç»‘å®šæ•™ç»ƒï¼šç‚¹å‡»æç¤ºå ä½
document.getElementById('bind-coach')?.addEventListener('click', function(){
  showToast('å³å°†å¼€é€šï¼Œæ•¬è¯·æœŸå¾…');
});
// ä½“è„‚æç¤ºæµ®å±‚
(()=>{
  const tipBtn = document.getElementById('ai-bf-tip');
  const tipBox = document.getElementById('ai-bf-tooltip');
  if(tipBtn && tipBox){
    let hideTimer;
    const show=()=>{ tipBox.classList.remove('hidden'); clearTimeout(hideTimer); hideTimer=setTimeout(()=>tipBox.classList.add('hidden'), 2500); };
    tipBtn.addEventListener('click', show);
    tipBtn.addEventListener('mouseenter', ()=>{ tipBox.classList.remove('hidden'); });
    tipBtn.addEventListener('mouseleave', ()=>{ tipBox.classList.add('hidden'); });
  }
})();
// ä¸ªäººèµ„æ–™é¡µï¼šAI å»ºè®®
document.getElementById('profile-ai-suggest')?.addEventListener('click', async ()=>{
  const h = +document.getElementById('f-height').value || 0;
  const w = +document.getElementById('f-weight').value || 0;
  const bf = +document.getElementById('f-bodyfat').value || 0;
  if (!h || !w) { showToast('è¯·å…ˆå¡«å†™èº«é«˜å’Œä½“é‡'); return; }
  const note = document.getElementById('profile-ai-note');
  if (note) note.textContent = 'AI ç”Ÿæˆä¸­...';
  try{
    const text = `è¯·ä¸ºä»¥ä¸‹ç”¨æˆ·ç”Ÿæˆä¸‰å¥—æ¯æ—¥è¥å…»ç›®æ ‡å»ºè®®ï¼ˆå¢è‚Œ/ç»´æŒ/å‡è„‚ï¼‰ï¼šèº«é«˜${h}cmï¼Œä½“é‡${w}kg${bf?`ï¼Œä½“è„‚${bf}%`:''}ã€‚ä¸¥æ ¼JSONè¿”å›ï¼špresets.high/normal/low å„å« calã€proã€fatã€carbsï¼ˆæ•°å€¼ï¼‰ã€‚`;
    const ret = await callAI({ text, image:null, mode:'goal' });
    const p = ret && ret.presets ? ret.presets : null;
    if (!p) { showToast('AI æœªè¿”å›æœ‰æ•ˆå»ºè®®'); if (note) note.textContent=''; return; }
    const box = document.getElementById('profile-ai-result');
    const card = (title, g) => `
      <div class="p-4 rounded-xl bg-neutral-50 dark:bg-neutral-700/50">
        <div class="font-medium mb-2">${title}</div>
        <div class="grid grid-cols-2 gap-2 text-sm">
          <div>çƒ­é‡ <span class="font-semibold">${g.cal||0}</span> kcal</div>
          <div>è›‹ç™½ <span class="font-semibold">${g.pro||0}</span> g</div>
          <div>è„‚è‚ª <span class="font-semibold">${g.fat||0}</span> g</div>
          <div>ç¢³æ°´ <span class="font-semibold">${g.carbs || Math.max(0, Math.round(((+g.cal||0) - (+g.pro||0)*4 - (+g.fat||0)*9)/4))}</span> g</div>
        </div>
      </div>`;
    box.innerHTML = [
      card('å¢è‚Œ', p.high||{}),
      card('ç»´æŒ', p.normal||{}),
      card('å‡è„‚', p.low||{})
    ].join('');
    if (note) note.textContent = ret.notes || '';
  }catch(e){
    console.error('AI å»ºè®®å¤±è´¥', e);
    showToast('AI ç”Ÿæˆå¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
    if (note) note.textContent = '';
  }
});

// ============== å¼€å‘è¾…åŠ©ï¼šä¸€é”®æ³¨å…¥å½“å¤©ç¤ºä¾‹é¤é¥®ï¼ˆç”¨äºæµ‹è¯•"å†å²è¯¦æƒ…å¼¹å±‚"ï¼‰ ==============
// ç¤ºä¾‹é¤æ³¨å…¥å·¥å…·ï¼ˆå·²ç¦ç”¨ï¼‰
    </script>
  </body>
</html>
